<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css" rel="stylesheet">
    <!-- FontAwesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <!-- JSMol for crystal structure visualization -->
    <script src="https://chemapps.stolaf.edu/jmol/jsmol/JSmol.min.js"></script>
    <!-- Mermaid for flowcharts -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        /* åŸºç¡€å­—ä½“å¤§å°è®¾ç½® */
        body { font-size: 16px; }
        p, .card-text, .text-muted, small { font-size: 1.1em; }
        .lead { font-size: 1.3em; }
        h1, h2, h3, h4, h5, h6 { font-size: 1.2em; }
        
        .sidebar { height: 100vh; overflow-y: auto; border-right: 1px solid #dee2e6; }
        .main-content { height: 100vh; overflow-y: auto; }
        .task-card { cursor: pointer; transition: all 0.2s; }
        .task-card:hover { background-color: #f8f9fa; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .task-card.active { background-color: #e3f2fd; border-left: 4px solid #1976d2; }
        .status-badge { font-size: 0.9em; }
        .log-entry { font-family: 'Courier New', monospace; font-size: 1em; padding: 8px; margin: 2px 0; border-radius: 4px; background-color: #f8f9fa; border-left: 3px solid #6c757d; }
        .log-entry.info { border-left-color: #17a2b8; }
        .log-entry.warning { border-left-color: #ffc107; }
        .log-entry.error { border-left-color: #dc3545; }
        .agent-activity { padding: 12px; margin: 5px 0; border-radius: 6px; border: 1px solid #ddd; font-size: 1.05em; }
        .agent-input { background-color: #e8f5e8; border-left: 4px solid #28a745; }
        .agent-output { background-color: #fff3cd; border-left: 4px solid #ffc107; }
        .tool-activity { padding: 12px; margin: 5px 0; border-radius: 6px; border: 1px solid #ddd; font-family: 'Courier New', monospace; font-size: 0.95em; }
        .tool-input { background-color: #f8d7da; border-left: 4px solid #dc3545; }
        .tool-output { background-color: #d1ecf1; border-left: 4px solid #17a2b8; }
        pre { white-space: pre-wrap; word-wrap: break-word; font-size: 1em; }
        .history-item.active { background-color: #e3f2fd; }
        
        /* è‡ªåŠ¨åˆ·æ–°æç¤º */
        .refresh-indicator { 
            position: fixed; 
            top: 10px; 
            right: 10px; 
            background: rgba(0,0,0,0.7); 
            color: white; 
            padding: 5px 10px; 
            border-radius: 15px; 
            font-size: 0.8em; 
            display: none; 
            z-index: 1000; 
        }
        .refresh-indicator.active { display: block; }
        
        /* Markdownå†…å®¹æ ·å¼ */
        .markdown-content { 
            font-size: 1.05em; 
            line-height: 1.6; 
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { 
            margin-top: 1em; 
            margin-bottom: 0.5em; 
        }
        .markdown-content p { 
            margin-bottom: 0.8em; 
        }
        .markdown-content code { 
            background-color: #f8f9fa; 
            padding: 2px 4px; 
            border-radius: 3px; 
            font-size: 0.9em; 
        }
        .markdown-content pre { 
            background-color: #f8f9fa; 
            padding: 1em; 
            border-radius: 5px; 
            overflow-x: auto; 
        }
        .markdown-content blockquote { 
            border-left: 4px solid #dee2e6; 
            padding-left: 1em; 
            margin: 1em 0; 
            color: #6c757d; 
        }
        

        /* å›¾ç‰‡æ˜¾ç¤ºæ ·å¼ */
        .content-image { 
            max-width: 100%; 
            height: auto; 
            margin: 1em 0; 
            border: 1px solid #dee2e6; 
            border-radius: 5px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        
        /* JSMolå®¹å™¨æ ·å¼ */
        .jsmol-container { 
            margin: 1em 0; 
            text-align: center; 
            border: 1px solid #dee2e6; 
            border-radius: 5px; 
            padding: 10px; 
            background-color: #f8f9fa; 
        }
        
        /* æ–‡ä»¶è·¯å¾„é«˜äº® */
        .file-path { 
            background-color: #e3f2fd; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-family: monospace; 
            font-size: 0.9em; 
        }
        
        /* æ–‡ä»¶é“¾æ¥å®¹å™¨ */
        .file-link-container {
            display: inline-flex;
            align-items: center;
            margin: 2px 0;
            padding: 4px 8px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        /* æ–‡ä»¶æ˜¾ç¤ºåŒºåŸŸæ ·å¼ */
        #file-display-area .content-image { 
            max-width: 100%; 
            max-height: 500px;
            height: auto; 
            margin: 1em auto;
            display: block;
            border: 1px solid #dee2e6; 
            border-radius: 5px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        
        #file-display-area .jsmol-container { 
            text-align: center; 
            padding: 20px; 
        }
        
        /* æµç¨‹å›¾æ ·å¼ */
        .workflow-chart { 
            margin: 1em 0; 
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .workflow-chart .mermaid { 
            text-align: center; 
        }
        
        /* æ´»åŠ¨å†å²ç®€åŒ–æ ·å¼ */
        .history-item-simple {
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .history-item-simple:hover {
            background-color: #f0f0f0;
        }
        
        .history-item-simple.active {
            background-color: #e3f2fd;
            border-left: 4px solid #1976d2;
        }
        
        .activity-badge {
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        /* é€šçŸ¥å¼¹çª—æ ·å¼ */
        .notification-popup {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: none;
            border-radius: 8px;
        }
        
        .notification-popup .btn-close {
            padding: 0.25rem;
            font-size: 0.75rem;
        }
    </style>
  </head>
<body>
    <!-- è‡ªåŠ¨åˆ·æ–°æç¤º -->
    <div class="refresh-indicator" id="refresh-indicator">ğŸ”„ Refreshing...</div>
    
    <div class="container-fluid">
        <div class="row">
            <!-- å·¦ä¾§è¾¹æ  -->
            <div class="col-md-3 sidebar bg-light p-3">
                <h4 class="mb-3">{{ title }}</h4>
                <div class="mb-3">
                    <a href="/" class="btn btn-outline-primary btn-sm">â† Back to home</a>
                </div>
                
                <!-- æœ€è¿‘ä»»åŠ¡ -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Recent missions</h6>
                    </div>
                    <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                        {% for recent_task in recent_tasks %}
                        <div class="task-card card mb-2 {% if recent_task.conversation_id == task.conversation_id %}active{% endif %}" 
                             onclick="window.location.href='/task/{{ recent_task.conversation_id }}'">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="small fw-bold">{{ recent_task.task_description[:50] }}{% if recent_task.task_description|length > 50 %}...{% endif %}</div>
                                        <small class="text-muted">{{ recent_task.created_at }}</small>
                                    </div>
                                    <span class="badge status-badge 
                                        {% if recent_task.status == 'completed' %}bg-success
                                        {% elif recent_task.status == 'running' %}bg-primary
                                        {% elif recent_task.status == 'failed' %}bg-danger
                                        {% elif recent_task.status == 'cancelled' %}bg-warning
                                        {% elif recent_task.status == 'queued' %}bg-secondary
                                        {% else %}bg-secondary
                                        {% endif %}">
                                        {% if recent_task.status == 'completed' %}Completed
                                        {% elif recent_task.status == 'running' %}Running
                                        {% elif recent_task.status == 'failed' %}Failed
                                        {% elif recent_task.status == 'cancelled' %}Cancelled
                                        {% elif recent_task.status == 'queued' %}Queued
                                        {% else %}Waiting
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- ä¸»å†…å®¹åŒº -->
            <div class="col-md-9 main-content p-3">
                <!-- ä»»åŠ¡åŸºæœ¬ä¿¡æ¯ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Task details</h5>
                            <div class="d-flex align-items-center">
                                <span class="badge main-task-status-badge
                                    {% if task.status == 'completed' %}bg-success
                                    {% elif task.status == 'running' %}bg-primary
                                    {% elif task.status == 'failed' %}bg-danger
                                    {% elif task.status == 'cancelled' %}bg-warning text-dark
                                    {% elif task.status == 'queued' %}bg-secondary
                                    {% else %}bg-secondary
                                    {% endif %}">
                                    {% if task.status == 'completed' %}Completed
                                    {% elif task.status == 'running' %}Running
                                    {% elif task.status == 'failed' %}Failed
                                    {% elif task.status == 'cancelled' %}Cancelled
                                    {% elif task.status == 'queued' %}Queued
                                    {% else %}ç­‰å¾…ä¸­
                                    {% endif %}
                                </span>
                                <!-- åœæ­¢ä»»åŠ¡æŒ‰é’® -->
                                {% if task.status in ['running', 'pending', 'queued'] %}
                                <button class="btn btn-danger btn-sm ms-2" id="stop-task-btn" onclick="stopTask()">
                                    <i class="fas fa-stop"></i> åœæ­¢ä»»åŠ¡
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title">{{ task.task_description }}</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <strong>Conversation ID:</strong> {{ task.conversation_id }}<br>
                                    <strong>Creation time:</strong> {{ task.created_at }}<br>
                                    {% if task.started_at %}
                                    <strong>Start time:</strong> {{ task.started_at }}<br>
                                    {% endif %}
                                    {% if task.completed_at %}
                                    <strong>Completion time:</strong> {{ task.completed_at }}<br>
                                    {% endif %}
                                </small>
                            </div>
                            <div class="col-md-6">
                                {% if task.error_message %}
                                <div class="alert alert-danger" role="alert">
                                    <strong>Error message:</strong> {{ task.error_message }}
                                </div>
                                {% endif %}
                                {% if task.result %}
                                <div class="alert alert-success" role="alert">
                                    <strong>Execution result:</strong> Task completed
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å·¥ä½œæµç¨‹å›¾ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-project-diagram"></i> Workflow
                            <!-- <small class="text-muted ms-2">ğŸ’¡ ç‚¹å‡»æµç¨‹å›¾ä¸­çš„èŠ‚ç‚¹å¯è·³è½¬åˆ°è¯¦æƒ…</small> -->
                        </h6>
                    </div>
                    <div class="card-body workflow-chart">
                        <div id="workflow-mermaid" class="mermaid">
                            <!-- æµç¨‹å›¾å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <div class="text-center mt-3" id="workflow-loading" style="display: none;">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="sr-only">ç”Ÿæˆæµç¨‹å›¾ä¸­...</span>
                            </div>
                            <small class="text-muted ms-2">æ­£åœ¨ç”Ÿæˆæµç¨‹å›¾...</small>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                <span style="color: #1976d2; background: #e3f2fd; padding: 2px 8px; border-radius: 8px; border: 2px solid #1976d2;">Agent</span> Agent &nbsp;
                                <span style="color: #f57c00; background: #fff3e0; padding: 2px 8px; border: 2px solid #f57c00;">Tool</span> Tool &nbsp;
                                <span style="color: #4caf50; background: #e8f5e8; padding: 2px 8px; border-radius: 50%; border: 2px solid #4caf50;">â—</span> start/end
                            </small>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- å·¦ä¾§ï¼šå†å²è®°å½•åˆ—è¡¨ -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Event history</h6>
                            </div>
                            <div class="card-body p-0" style="max-height: 600px; overflow-y: auto;">
                                <div class="list-group list-group-flush">
                                    {% for log in logs %}
                                    <div class="list-group-item list-group-item-action history-item" 
                                         data-type="{{ log.type }}" 
                                         data-role-name="{{ log.role_name or '' }}"
                                         data-content="{{ log.content|escape }}"
                                         data-timestamp="{{ log.timestamp }}"
                                         data-log-index="{{ loop.index0 }}">
                                        <div class="d-flex w-100 justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <span class="activity-badge 
                                                    {% if log.type == 'system' %}bg-secondary text-white
                                                    {% elif log.type == 'agent_input' %}bg-success text-white
                                                    {% elif log.type == 'agent_output' %}bg-warning text-dark
                                                    {% elif log.type == 'tool_input' %}bg-danger text-white
                                                    {% elif log.type == 'tool_output' %}bg-info text-white
                                                    {% endif %}">
                                                                                        {% if log.type == 'agent_input' %}
                                        <i class="fas fa-robot"></i> {% if log.role_name %}{{ log.role_name }} input{% else %}Agent input{% endif %}
                                    {% elif log.type == 'agent_output' %}
                                        <i class="fas fa-robot"></i> {% if log.role_name %}{{ log.role_name }} output{% else %}Agent output{% endif %}
                                    {% elif log.type == 'tool_input' %}
                                        <i class="fas fa-tools"></i> {% if log.role_name %}{{ log.role_name }} call{% else %}Tool call{% endif %}
                                    {% elif log.type == 'tool_output' %}
                                        <i class="fas fa-tools"></i> {% if log.role_name %}{{ log.role_name }} result{% else %}Tool result{% endif %}
                                    {% else %}
                                        <i class="fas fa-info-circle"></i> {{ log.type_name }}
                                    {% endif %}
                                                </span>
                                            </div>
                                            <small class="text-muted">{{ log.timestamp }}</small>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å³ä¾§ï¼šè¯¦æƒ…æ˜¾ç¤º -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0" id="detail-title">Select an item on the left to view details</h6>
                            </div>
                            <div class="card-body" id="detail-content">
                                <div class="text-center text-muted">
                                    <p>Click on the history record item on the left to view detailed content.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ–‡ä»¶æ˜¾ç¤ºåŒºåŸŸ -->
                        <div class="card mt-3" id="file-display-area" style="display: none;">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0" id="file-display-title">File preview</h6>
                                <button class="btn btn-sm btn-outline-secondary" onclick="closeFileDisplay()">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                            <div class="card-body" id="file-display-content">
                                <!-- åŠ¨æ€å†…å®¹åŒºåŸŸ -->
                            </div>
                        </div>
                        
                        {% if task.result %}
                        <!-- éšè—çš„é™æ€æ•°æ®ä¼ é€’å…ƒç´  -->
                        <div data-static-result="{{ task.result|escape }}" style="display: none;"></div>
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">Final result</h6>
                            </div>
                            <div class="card-body">
                                <div class="markdown-content" id="final-result-content">
                                    <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ¸²æŸ“ -->
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <script>
    let currentTaskData = null;
    let refreshInterval = null;
    let lastUpdateTime = 0;
    let isUpdating = false;
    
    // é¡µé¢åŠ è½½æ—¶æ¸…ç†ä»»ä½•é—ç•™çš„å®šæ—¶å™¨
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
    
    // æŸ¥æ‰¾å¹¶å¤„ç†æ–‡ä»¶è·¯å¾„
    function processFilePaths(content) {
        // ä¸å†å› ä¸ºåŒ…å« file-link-container è€Œæ•´ä½“è·³è¿‡ï¼Œé¿å…é—æ¼åç»­æ–°è·¯å¾„
        let processedContent = content;
        
        // ä¸“é—¨å¤„ç†å·²ç»åœ¨<code>æ ‡ç­¾å†…çš„æ–‡ä»¶è·¯å¾„
        function processCodeElements(content) {
            const filePatterns = [
                { ext: 'png', buttonClass: 'primary', iconClass: 'image', iconText: 'View image', showFunction: 'showImageFile' },
                { ext: 'vasp', buttonClass: 'success', iconClass: 'cube', iconText: 'View structure', showFunction: 'showVaspFile' },
                { ext: 'xyz', buttonClass: 'success', iconClass: 'cube', iconText: 'View structure', showFunction: 'showVaspFile' },
                { ext: 'cif', buttonClass: 'success', iconClass: 'cube', iconText: 'View structure', showFunction: 'showVaspFile' }
            ];
            
            let processedContent = content;
            
            // å¯¹æ¯ç§æ–‡ä»¶ç±»å‹è¿›è¡Œå¤„ç†
            filePatterns.forEach(pattern => {
                // ç®€å•ä½†å¯é çš„æ–¹æ³•ï¼šæŸ¥æ‰¾ç‹¬ç«‹çš„<code>æ ‡ç­¾
                const codePattern = new RegExp(
                    '<code>(\/[^<]*\\.' + pattern.ext + ')</code>',
                    'gi'
                );
                
                processedContent = processedContent.replace(codePattern, function(match, filePath, offset, string) {
                    // æ£€æŸ¥å‘¨å›´çš„ä¸Šä¸‹æ–‡ï¼Œç¡®ä¿ä¸æ˜¯å·²ç»å¤„ç†è¿‡çš„
                    const beforeMatch = string.substring(Math.max(0, offset - 100), offset);
                    const afterMatch = string.substring(offset + match.length, offset + match.length + 100);
                    
                    // å¦‚æœå‰é¢æœ‰file-link-containeræˆ–file-pathï¼Œè¯´æ˜å·²ç»å¤„ç†è¿‡äº†
                    if (beforeMatch.includes('file-link-container') || beforeMatch.includes('file-path')) {
                        return match;
                    }
                    
                    // å¦‚æœåé¢ç´§è·Ÿç€buttonæ ‡ç­¾ï¼Œè¯´æ˜å·²ç»å¤„ç†è¿‡äº†
                    if (afterMatch.trim().startsWith('<button')) {
                        return match;
                    }
                    
                    const cleanPath = filePath.trim();
                    
                    // æ£€æŸ¥è·¯å¾„æ˜¯å¦åˆç†
                    if (cleanPath.includes('&lt;') || cleanPath.includes('&gt;') || 
                        cleanPath.length < 5 || cleanPath.includes('<') || cleanPath.includes('>')) {
                        return match; // è·³è¿‡ä¸åˆç†çš„è·¯å¾„
                    }
                    
                    const encodedPath = encodeURIComponent(cleanPath);
                    const buttonId = pattern.ext + '_btn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    
                    console.log('å¤„ç†<code>å†…çš„æ–‡ä»¶è·¯å¾„:', cleanPath);
                    
                    return '<span class="file-link-container">' +
                            '<code class="file-path">' + cleanPath + '</code>' +
                            '<button class="btn btn-sm btn-outline-' + pattern.buttonClass + ' ms-2" id="' + buttonId + '" onclick="' + pattern.showFunction + '(decodeURIComponent(\'' + encodedPath + '\'), \'' + buttonId + '\')">' +
                                '<i class="fas fa-' + pattern.iconClass + '"></i> ' + pattern.iconText +
                            '</button>' +
                        '</span>';
                });
            });
            
            return processedContent;
        }
        
        // é¦–å…ˆå¤„ç†<code>å…ƒç´ å†…çš„æ–‡ä»¶è·¯å¾„
        processedContent = processCodeElements(processedContent);
        
        // å®‰å…¨çš„æ–‡ä»¶è·¯å¾„å¤„ç†å‡½æ•°
        function processFilePathsSafely(content, fileExtension, buttonClass, iconClass, iconText, showFunction) {
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å®¹å™¨æ¥è§£æHTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            // è·å–æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹ï¼ˆä¸åœ¨HTMLæ ‡ç­¾å†…çš„çº¯æ–‡æœ¬ï¼‰
            const walker = document.createTreeWalker(
                tempDiv,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            const textNodes = [];
            let node;
            while (node = walker.nextNode()) {
                textNodes.push(node);
            }
            
            // å¤„ç†æ¯ä¸ªæ–‡æœ¬èŠ‚ç‚¹
            textNodes.forEach(textNode => {
                const text = textNode.textContent;
                const pattern = new RegExp('(/[^\\s\'\"<>]*\\.' + fileExtension + ')\\b', 'gi');
                const matches = [...text.matchAll(pattern)];
                
                if (matches.length > 0) {
                    // æ£€æŸ¥çˆ¶å…ƒç´ æ˜¯å¦å·²ç»æ˜¯codeã€preç­‰æ ‡ç­¾
                    const parent = textNode.parentElement;
                    const isInCodeElement = parent && (
                        parent.tagName.toLowerCase() === 'code' ||
                        parent.tagName.toLowerCase() === 'pre' ||
                        parent.closest('code') ||
                        parent.closest('pre') ||
                        parent.classList.contains('file-path') ||
                        parent.classList.contains('file-link-container')
                    );
                    
                    if (!isInCodeElement) {
                        // æ›¿æ¢æ–‡æœ¬èŠ‚ç‚¹å†…å®¹
                        let newHTML = text;
                        matches.reverse().forEach(match => { // å€’åºå¤„ç†é¿å…ä½ç½®åç§»
                            const filePath = match[1].trim();
                            const encodedPath = encodeURIComponent(filePath);
                            const buttonId = fileExtension + '_btn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            
                            const buttonHtml = 
                                '<span class="file-link-container">' +
                                    '<code class="file-path">' + filePath + '</code>' +
                                    '<button class="btn btn-sm btn-outline-' + buttonClass + ' ms-2" id="' + buttonId + '" onclick="' + showFunction + '(decodeURIComponent(\'' + encodedPath + '\'), \'' + buttonId + '\')">' +
                                        '<i class="fas fa-' + iconClass + '"></i> ' + iconText +
                                    '</button>' +
                                '</span>';
                            
                            const startIndex = match.index;
                            const endIndex = startIndex + match[0].length;
                            newHTML = newHTML.substring(0, startIndex) + buttonHtml + newHTML.substring(endIndex);
                        });
                        
                        // åˆ›å»ºæ–°çš„HTMLèŠ‚ç‚¹æ¥æ›¿æ¢æ–‡æœ¬èŠ‚ç‚¹
                        if (newHTML !== text) {
                            const wrapper = document.createElement('span');
                            wrapper.innerHTML = newHTML;
                            textNode.parentNode.replaceChild(wrapper, textNode);
                        }
                    } else {
                        console.log('è·³è¿‡å·²åœ¨HTMLæ ‡ç­¾å†…çš„æ–‡ä»¶è·¯å¾„:', text.trim());
                    }
                }
            });
            
            return tempDiv.innerHTML;
        }
        
        // å¤„ç†.pngå›¾ç‰‡æ–‡ä»¶
        try {
            processedContent = processFilePathsSafely(processedContent, 'png', 'primary', 'image', 'Show image', 'showImageFile');
        } catch (error) {
            console.warn('Error processing PNG file path:', error);
            // å›é€€åˆ°ç®€å•çš„æ­£åˆ™å¤„ç†ï¼Œä½†å¢åŠ å®‰å…¨æ£€æŸ¥
            const imagePattern = /(?<!<[^>]*?)(\/[^\s'"<>]*\.png)\b(?![^<]*?>)/gi;
            processedContent = processedContent.replace(imagePattern, function(match, filePath, offset, string) {
                // æ£€æŸ¥æ˜¯å¦åœ¨HTMLæ ‡ç­¾å†…
                const beforeMatch = string.substring(0, offset);
                const afterMatch = string.substring(offset + match.length);
                const lastOpenTag = beforeMatch.lastIndexOf('<');
                const lastCloseTag = beforeMatch.lastIndexOf('>');
                const nextCloseTag = afterMatch.indexOf('>');
                
                // å¦‚æœåœ¨HTMLæ ‡ç­¾å†…åˆ™è·³è¿‡
                if (lastOpenTag > lastCloseTag && nextCloseTag !== -1) {
                    return match;
                }
                
                const cleanPath = filePath.trim();
                const encodedPath = encodeURIComponent(cleanPath);
                const buttonId = 'img_btn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                return '<span class="file-link-container">' +
                        '<code class="file-path">' + cleanPath + '</code>' +
                        '<button class="btn btn-sm btn-outline-primary ms-2" id="' + buttonId + '" onclick="showImageFile(decodeURIComponent(\'' + encodedPath + '\'), \'' + buttonId + '\')">' +
                            '<i class="fas fa-image"></i> View image' +
                        '</button>' +
                    '</span>';
            });
        }
        
        // å¤„ç†.vaspæ™¶ä½“ç»“æ„æ–‡ä»¶
        try {
            processedContent = processFilePathsSafely(processedContent, 'vasp', 'success', 'cube', 'Show structure', 'showVaspFile');
        } catch (error) {
            console.warn('Error processing VASP file path:', error);
            // å›é€€åˆ°ç®€å•çš„æ­£åˆ™å¤„ç†ï¼Œä½†å¢åŠ å®‰å…¨æ£€æŸ¥
            const vaspPattern = /(?<!<[^>]*?)(\/[^\s'"<>]*\.vasp)\b(?![^<]*?>)/gi;
            processedContent = processedContent.replace(vaspPattern, function(match, filePath, offset, string) {
                // æ£€æŸ¥æ˜¯å¦åœ¨HTMLæ ‡ç­¾å†…
                const beforeMatch = string.substring(0, offset);
                const afterMatch = string.substring(offset + match.length);
                const lastOpenTag = beforeMatch.lastIndexOf('<');
                const lastCloseTag = beforeMatch.lastIndexOf('>');
                const nextCloseTag = afterMatch.indexOf('>');
                
                // å¦‚æœåœ¨HTMLæ ‡ç­¾å†…åˆ™è·³è¿‡
                if (lastOpenTag > lastCloseTag && nextCloseTag !== -1) {
                    return match;
                }
                
                const cleanPath = filePath.trim();
                const encodedPath = encodeURIComponent(cleanPath);
                const buttonId = 'vasp_btn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                return '<span class="file-link-container">' +
                        '<code class="file-path">' + cleanPath + '</code>' +
                        '<button class="btn btn-sm btn-outline-success ms-2" id="' + buttonId + '" onclick="showVaspFile(decodeURIComponent(\'' + encodedPath + '\'), \'' + buttonId + '\')">' +
                            '<i class="fas fa-cube"></i> View structure' +
                        '</button>' +
                    '</span>';
            });
        }
        
        // å¤„ç†.xyzæ™¶ä½“ç»“æ„æ–‡ä»¶
        try {
            processedContent = processFilePathsSafely(processedContent, 'xyz', 'success', 'cube', 'æŸ¥çœ‹ç»“æ„', 'showVaspFile');
        } catch (error) {
            console.warn('å¤„ç†XYZæ–‡ä»¶è·¯å¾„æ—¶å‡ºé”™:', error);
            // å›é€€åˆ°ç®€å•çš„æ­£åˆ™å¤„ç†
            const xyzPattern = /(?<!<[^>]*?)(\/[^\s'"<>]*\.xyz)\b(?![^<]*?>)/gi;
            processedContent = processedContent.replace(xyzPattern, function(match, filePath, offset, string) {
                const beforeMatch = string.substring(0, offset);
                const afterMatch = string.substring(offset + match.length);
                const lastOpenTag = beforeMatch.lastIndexOf('<');
                const lastCloseTag = beforeMatch.lastIndexOf('>');
                const nextCloseTag = afterMatch.indexOf('>');
                
                if (lastOpenTag > lastCloseTag && nextCloseTag !== -1) {
                    return match;
                }
                
                const cleanPath = filePath.trim();
                const encodedPath = encodeURIComponent(cleanPath);
                const buttonId = 'xyz_btn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                return '<span class="file-link-container">' +
                        '<code class="file-path">' + cleanPath + '</code>' +
                        '<button class="btn btn-sm btn-outline-success ms-2" id="' + buttonId + '" onclick="showVaspFile(decodeURIComponent(\'' + encodedPath + '\'), \'' + buttonId + '\')">' +
                            '<i class="fas fa-cube"></i> View structure' +
                        '</button>' +
                    '</span>';
            });
        }
        
        // å¤„ç†.cifæ™¶ä½“ç»“æ„æ–‡ä»¶
        try {
            processedContent = processFilePathsSafely(processedContent, 'cif', 'success', 'cube', 'æŸ¥çœ‹ç»“æ„', 'showVaspFile');
        } catch (error) {
            console.warn('å¤„ç†CIFæ–‡ä»¶è·¯å¾„æ—¶å‡ºé”™:', error);
            // å›é€€åˆ°ç®€å•çš„æ­£åˆ™å¤„ç†
            const cifPattern = /(?<!<[^>]*?)(\/[^\s'"<>]*\.cif)\b(?![^<]*?>)/gi;
            processedContent = processedContent.replace(cifPattern, function(match, filePath, offset, string) {
                const beforeMatch = string.substring(0, offset);
                const afterMatch = string.substring(offset + match.length);
                const lastOpenTag = beforeMatch.lastIndexOf('<');
                const lastCloseTag = beforeMatch.lastIndexOf('>');
                const nextCloseTag = afterMatch.indexOf('>');
                
                if (lastOpenTag > lastCloseTag && nextCloseTag !== -1) {
                    return match;
                }
                
                const cleanPath = filePath.trim();
                const encodedPath = encodeURIComponent(cleanPath);
                const buttonId = 'cif_btn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                return '<span class="file-link-container">' +
                        '<code class="file-path">' + cleanPath + '</code>' +
                        '<button class="btn btn-sm btn-outline-success ms-2" id="' + buttonId + '" onclick="showVaspFile(decodeURIComponent(\'' + encodedPath + '\'), \'' + buttonId + '\')">' +
                            '<i class="fas fa-cube"></i> View structure' +
                        '</button>' +
                    '</span>';
            });
        }
        
        return processedContent;
    }
    
    // æ¸²æŸ“å†…å®¹
    function renderContent(content, type) {
        if (type === 'tool_input' || type === 'tool_output') {
            const processedContent = processFilePaths(content);
            return '<pre class="mb-0">' + processedContent + '</pre>';
        } else if (type === 'agent_input' || type === 'agent_output') {
            try {
                const rendered = marked.parse(content);
                const processedContent = processFilePaths(rendered);
                return '<div class="markdown-content">' + processedContent + '</div>';
            } catch (e) {
                const processedContent = processFilePaths(content);
                return '<pre class="mb-0">' + processedContent + '</pre>';
            }
        } else {
            return '<pre class="mb-0">' + content + '</pre>';
        }
    }
    
    // æ˜¾ç¤ºåˆ·æ–°æŒ‡ç¤ºå™¨
    function showRefreshIndicator() {
        const indicator = document.getElementById('refresh-indicator');
        if (indicator) {
            indicator.classList.add('active');
            setTimeout(() => indicator.classList.remove('active'), 1000);
        }
    }
    
    // æ›´æ–°ä»»åŠ¡çŠ¶æ€å¾½ç« ï¼ˆåªæ›´æ–°ä¸»ä»»åŠ¡çŠ¶æ€ï¼Œä¸å½±å“ä¾§è¾¹æ ï¼‰
    function updateTaskStatus(status) {
        // åªæ›´æ–°ä¸»ä»»åŠ¡çš„çŠ¶æ€æ ‡ç­¾ï¼Œé¿å…å½±å“ä¾§è¾¹æ çš„å…¶ä»–ä»»åŠ¡
        const mainTaskBadge = document.querySelector('.main-task-status-badge');
        if (!mainTaskBadge) return;
        
        // æ£€æŸ¥å½“å‰çŠ¶æ€æ˜¯å¦å·²ç»æ­£ç¡®ï¼Œé¿å…ä¸å¿…è¦çš„æ›´æ–°
        let currentStatus = '';
        if (mainTaskBadge.textContent.trim() === 'Completed') currentStatus = 'completed';
        else if (mainTaskBadge.textContent.trim() === 'Running') currentStatus = 'running';
        else if (mainTaskBadge.textContent.trim() === 'Failed') currentStatus = 'failed';
        else if (mainTaskBadge.textContent.trim() === 'Cancelled') currentStatus = 'cancelled';
        else if (mainTaskBadge.textContent.trim() === 'Queued') currentStatus = 'queued';
        else currentStatus = 'pending';
        
        // åªæœ‰å½“çŠ¶æ€çœŸçš„å‘ç”Ÿå˜åŒ–æ—¶æ‰æ›´æ–°
        if (currentStatus !== status) {
            console.log('Main task status updated: ' + currentStatus + ' â†’ ' + status);
            mainTaskBadge.className = 'badge main-task-status-badge';
            if (status === 'completed') {
                mainTaskBadge.className += ' bg-success';
                mainTaskBadge.textContent = 'Completed';
            } else if (status === 'running') {
                mainTaskBadge.className += ' bg-primary';
                mainTaskBadge.textContent = 'Running';
            } else if (status === 'failed') {
                mainTaskBadge.className += ' bg-danger';
                mainTaskBadge.textContent = 'Failed';
            } else if (status === 'cancelled') {
                mainTaskBadge.className += ' bg-warning text-dark';
                mainTaskBadge.textContent = 'Cancelled';
            } else if (status === 'queued') {
                mainTaskBadge.className += ' bg-secondary';
                mainTaskBadge.textContent = 'Queued';
            } else {
                mainTaskBadge.className += ' bg-secondary';
                mainTaskBadge.textContent = 'Waiting';
            }
            
            // æ ¹æ®ä»»åŠ¡çŠ¶æ€æ˜¾ç¤ºæˆ–éšè—åœæ­¢æŒ‰é’®
            updateStopButton(status);
        }
    }
    
    // æ›´æ–°åœæ­¢æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
    function updateStopButton(status) {
        const stopBtn = document.getElementById('stop-task-btn');
        if (stopBtn) {
            if (status === 'running' || status === 'pending' || status === 'queued') {
                stopBtn.style.display = 'inline-block';
            } else {
                stopBtn.style.display = 'none';
            }
        }
    }
    
    // åœæ­¢ä»»åŠ¡å‡½æ•°
    async function stopTask() {
        const stopBtn = document.getElementById('stop-task-btn');
        if (!stopBtn) return;
        
        // ç¡®è®¤å¯¹è¯æ¡†
        if (!confirm('ç¡®å®šè¦åœæ­¢å½“å‰ä»»åŠ¡å—ï¼Ÿ\n\nåœæ­¢ä»»åŠ¡åå°†æ— æ³•æ¢å¤ï¼Œæ­£åœ¨è¿›è¡Œçš„è®¡ç®—ä¹Ÿä¼šè¢«å–æ¶ˆã€‚')) {
            return;
        }
        
        try {
            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            stopBtn.disabled = true;
            const originalContent = stopBtn.innerHTML;
            stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åœæ­¢ä¸­...';
            
            const taskId = getCurrentTaskId();
            const response = await fetch('/api/task/' + taskId + '/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                // åœæ­¢æˆåŠŸ
                console.log('ä»»åŠ¡åœæ­¢æˆåŠŸ:', result);
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showNotification('ä»»åŠ¡å·²åœæ­¢', 'success');
                
                // æ›´æ–°ä»»åŠ¡çŠ¶æ€
                updateTaskStatus('cancelled');
                
                // åœæ­¢è‡ªåŠ¨åˆ·æ–°
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
                
                // è·å–æœ€æ–°æ•°æ®ä»¥æ›´æ–°ç•Œé¢
                setTimeout(() => {
                    fetchLatestData(true);
                }, 1000);
                
            } else {
                // åœæ­¢å¤±è´¥
                console.error('åœæ­¢ä»»åŠ¡å¤±è´¥:', result);
                showNotification(result.error || 'åœæ­¢ä»»åŠ¡å¤±è´¥', 'error');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                stopBtn.disabled = false;
                stopBtn.innerHTML = originalContent;
            }
            
        } catch (error) {
            console.error('åœæ­¢ä»»åŠ¡æ—¶å‘ç”Ÿé”™è¯¯:', error);
            showNotification('åœæ­¢ä»»åŠ¡æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            stopBtn.disabled = false;
            stopBtn.innerHTML = originalContent;
        }
    }
    
    // æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
    function showNotification(message, type = 'info') {
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} notification-popup`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            opacity: 0;
            transition: opacity 0.3s ease;
        `;
        
        notification.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                <span>${message}</span>
                <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // æ˜¾ç¤ºåŠ¨ç”»
        setTimeout(() => {
            notification.style.opacity = '1';
        }, 100);
        
        // è‡ªåŠ¨éšè—
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 5000);
    }
    
    // æå–å·¥å…·åç§°çš„è¾…åŠ©å‡½æ•°
    function extractToolName(content) {
        try {
            const data = JSON.parse(content);
            if (data.tool_name) return data.tool_name;
            if (data.name) return data.name;
            if (data.function && data.function.name) return data.function.name;
            if (data.tool && data.tool.name) return data.tool.name;
            if (data.method) return data.method;
            if (data.action) return data.action;
            
            // æŸ¥æ‰¾å¯èƒ½çš„åç§°å­—æ®µ
            const keys = Object.keys(data);
            const possibleNames = keys.filter(key => 
                key.toLowerCase().includes('name') || 
                key.toLowerCase().includes('tool') ||
                key.toLowerCase().includes('method') ||
                key.toLowerCase().includes('action')
            );
            if (possibleNames.length > 0) {
                const value = data[possibleNames[0]];
                if (typeof value === 'string' && value.trim() !== '') {
                    return value.trim();
                }
            }
        } catch (e) {}
        return null;
    }
    
    // æå–Agentåç§°çš„è¾…åŠ©å‡½æ•°
    function extractAgentName(content) {
        try {
            const data = JSON.parse(content);
            if (data.agent_name) return data.agent_name;
            if (data.name) return data.name;
            if (data.role) return data.role;
            if (data.agent) return data.agent;
        } catch (e) {}
        return null;
    }

    // æ›´æ–°å†å²è®°å½•åˆ—è¡¨
    function updateHistoryList(logs) {
        const historyContainer = document.querySelector('.list-group');
        if (!historyContainer) return;
        
        // é˜²æŠ–ä¿æŠ¤ï¼šé¿å…çŸ­æ—¶é—´å†…é‡å¤æ›´æ–°
        const now = Date.now();
        if (isUpdating || (now - lastUpdateTime < 500)) {
            console.log('â­ï¸ Skip history record update');
            return;
        }
        
        isUpdating = true;
        lastUpdateTime = now;
        
        console.log('ğŸ”„ Start updating history record list, log number:', logs.length);
        
        try {
            // ä¿å­˜å½“å‰é€‰ä¸­çš„é¡¹ç›®
            const activeItem = historyContainer.querySelector('.history-item.active');
            const activeTimestamp = activeItem ? activeItem.dataset.timestamp : null;
            
            // æ€»æ˜¯å®Œå…¨é‡å»ºåˆ—è¡¨ä»¥é¿å…é‡å¤æ˜¾ç¤ºé—®é¢˜
            console.log('ğŸ“ Completely rebuild history record list');
            historyContainer.innerHTML = '';
            
            // é‡æ–°åˆ›å»ºæ‰€æœ‰å†å²è®°å½•é¡¹
            logs.forEach((log, index) => {
                const historyItem = createHistoryItem(log, index);
                historyContainer.appendChild(historyItem);
            });
            
            // æ¢å¤é€‰ä¸­çŠ¶æ€
            if (activeTimestamp) {
                const newActiveItem = historyContainer.querySelector(`[data-timestamp="${activeTimestamp}"]`);
                if (newActiveItem) {
                    newActiveItem.classList.add('active');
                }
            }
            
            console.log('âœ… History record list updated, total', logs.length, 'items');
        } finally {
            // ç¡®ä¿åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¼šé‡ç½®æ›´æ–°çŠ¶æ€
            setTimeout(() => {
                isUpdating = false;
            }, 100);
        }
    }
    
    // åˆ›å»ºå†å²è®°å½•é¡¹ç›®
    function createHistoryItem(log, index) {
        const historyItem = document.createElement('div');
        historyItem.className = 'list-group-item list-group-item-action history-item';
        historyItem.dataset.type = log.type;
        historyItem.dataset.roleName = log.role_name || '';
        historyItem.dataset.content = log.content;
        historyItem.dataset.timestamp = log.timestamp;
        if (typeof index === 'number') {
            historyItem.dataset.logIndex = index;
        }
        
        // è°ƒè¯•ä¿¡æ¯ï¼ˆå·²ç§»é™¤ä»¥å‡å°‘æ§åˆ¶å°å™ªéŸ³ï¼‰
        
        let badgeClass = 'bg-secondary text-white';
        let badgeText = log.type_name;
        let badgeIcon = 'fas fa-info-circle';
        let specificName = '';
        
        if (log.type === 'system') {
            badgeClass = 'bg-secondary text-white';
            badgeIcon = 'fas fa-info-circle';
            badgeText = log.type_name;
        } else if (log.type === 'agent_input') {
            badgeClass = 'bg-success text-white';
            badgeIcon = 'fas fa-robot';
            specificName = log.role_name;
            badgeText = specificName ? specificName + ' input' : 'Agent input';
        } else if (log.type === 'agent_output') {
            badgeClass = 'bg-warning text-dark';
            badgeIcon = 'fas fa-robot';
            specificName = log.role_name;
            badgeText = specificName ? specificName + ' output' : 'Agent output';
        } else if (log.type === 'tool_input') {
            badgeClass = 'bg-danger text-white';
            badgeIcon = 'fas fa-tools';
            specificName = log.role_name;
            badgeText = specificName ? specificName + ' call' : 'Tool call';
        } else if (log.type === 'tool_output') {
            badgeClass = 'bg-info text-white';
            badgeIcon = 'fas fa-tools';
            specificName = log.role_name;
            badgeText = specificName ? specificName + ' result' : 'Tool result';
        }
        
        historyItem.innerHTML = 
            '<div class="d-flex w-100 justify-content-between align-items-center">' +
                '<div class="d-flex align-items-center">' +
                    '<span class="activity-badge ' + badgeClass + '">' +
                        '<i class="' + badgeIcon + '"></i> ' + badgeText +
                    '</span>' +
                '</div>' +
                '<small class="text-muted">' + log.timestamp + '</small>' +
            '</div>';
        
        return historyItem;
    }
    
    // ç”Ÿæˆå·¥ä½œæµç¨‹å›¾
    async function generateWorkflowChart(logs) {
        const workflowContainer = document.getElementById('workflow-mermaid');
        const loadingIndicator = document.getElementById('workflow-loading');
        
        if (!workflowContainer || !logs || logs.length === 0) {
            return;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        loadingIndicator.style.display = 'block';
        workflowContainer.innerHTML = '';
        
        try {
            // åˆ†ææ—¥å¿—ï¼Œæå–Agentå’ŒToolåºåˆ—
            const activities = [];
            let currentAgent = null;
            let agentTools = [];
            let agentIndex = 0;
            let toolIndex = 0;
            
            logs.forEach((log, index) => {
                // è¿‡æ»¤æ‰managerç›¸å…³çš„æ—¥å¿—ï¼Œè¿™äº›é€šå¸¸æ˜¯æ¡†æ¶å†…éƒ¨çš„ç®¡ç†å™¨èŠ‚ç‚¹
                const isManagerRelated = log.role_name && log.role_name.toLowerCase().includes('manager');
                
                if (isManagerRelated) {
                    return; // è·³è¿‡managerç›¸å…³çš„æ—¥å¿—
                }
                
                if (log.type === 'agent_input') {
                    // å¦‚æœä¹‹å‰æœ‰Agentï¼Œå…ˆä¿å­˜å®ƒ
                    if (currentAgent) {
                        // æŸ¥æ‰¾å¯¹åº”çš„agent_output
                        const outputLog = logs.find((l, idx) => 
                            idx > currentAgent.logIndex && 
                            l.type === 'agent_output' && 
                            l.role_name === currentAgent.originalName
                        );
                        
                        activities.push({
                            type: 'agent',
                            id: 'agent' + (agentIndex++),
                            name: currentAgent.name,
                            tools: [...agentTools],
                            timestamp: currentAgent.timestamp,
                            logIndex: currentAgent.logIndex,
                            outputTimestamp: outputLog ? outputLog.timestamp : currentAgent.timestamp,
                            outputLogIndex: outputLog ? logs.indexOf(outputLog) : currentAgent.logIndex
                        });
                    }
                    
                    // ç›´æ¥ä½¿ç”¨role_nameå­—æ®µ
                    let agentName = log.role_name || 'Agent-' + (agentIndex + 1);
                    const originalName = log.role_name;
                    
                    // è°ƒè¯•ä¿¡æ¯ï¼ˆå·²ç§»é™¤ï¼‰
                    
                    // é™åˆ¶é•¿åº¦ä»¥é¿å…æµç¨‹å›¾è¿‡å®½
                    if (agentName.length > 25) {
                        agentName = agentName.substring(0, 22) + '...';
                    }
                    
                    // å¼€å§‹æ–°çš„Agentæ´»åŠ¨
                    currentAgent = {
                        name: agentName,
                        originalName: originalName,
                        timestamp: log.timestamp,
                        logIndex: index
                    };
                    agentTools = [];
                    
                } else if (log.type === 'tool_input' && currentAgent) {
                    // ç›´æ¥ä½¿ç”¨role_nameå­—æ®µ
                    let toolName = log.role_name || 'Tool-' + (toolIndex + 1);
                    
                    // è°ƒè¯•ä¿¡æ¯ï¼ˆå·²ç§»é™¤ï¼‰
                    
                    // é™åˆ¶é•¿åº¦ä»¥é¿å…æµç¨‹å›¾è¿‡å®½
                    if (toolName.length > 20) {
                        toolName = toolName.substring(0, 17) + '...';
                    }
                    
                    agentTools.push({
                        id: 'tool' + (toolIndex++),
                        name: toolName,
                        timestamp: log.timestamp,
                        logIndex: index
                    });
                }
            });
            
            // ä¿å­˜æœ€åä¸€ä¸ªAgent
            if (currentAgent) {
                // æŸ¥æ‰¾å¯¹åº”çš„agent_output
                const outputLog = logs.find((l, idx) => 
                    idx > currentAgent.logIndex && 
                    l.type === 'agent_output' && 
                    l.role_name === currentAgent.originalName
                );
                
                activities.push({
                    type: 'agent',
                    id: 'agent' + (agentIndex++),
                    name: currentAgent.name,
                    tools: [...agentTools],
                    timestamp: currentAgent.timestamp,
                    logIndex: currentAgent.logIndex,
                    outputTimestamp: outputLog ? outputLog.timestamp : currentAgent.timestamp,
                    outputLogIndex: outputLog ? logs.indexOf(outputLog) : currentAgent.logIndex
                });
            }
            
            // åˆ›å»ºå·¥å…·åˆ—è¡¨ï¼ˆåœ¨å¤–éƒ¨ä½œç”¨åŸŸï¼‰
            const allTools = [];
            activities.forEach(activity => {
                activity.tools.forEach(tool => {
                    allTools.push({
                        agentId: activity.id,
                        agentName: activity.name,
                        ...tool
                    });
                });
            });
            
            // ç”ŸæˆMermaidæµç¨‹å›¾ä»£ç  - æ”¹ä¸ºæ°´å¹³å¸ƒå±€
            let mermaidCode = 'graph LR\n';
            
            if (activities.length === 0) {
                mermaidCode += '    Start([Start]) --> End([End])\n';
            } else {
                // æ·»åŠ å¼€å§‹èŠ‚ç‚¹
                mermaidCode += '    Start([Start])\n';
                
                // åˆ›å»ºAgentèŠ‚ç‚¹ - ä½¿ç”¨åœ†è§’é•¿æ–¹å½¢
                activities.forEach((activity, index) => {
                    // æ¸…ç†Agentåç§°ï¼Œç¡®ä¿ä½¿ç”¨å…·ä½“åç§°
                    let safeName = activity.name.replace(/[^\w\s\-\.\u4e00-\u9fff]/g, '').trim();
                    if (!safeName || safeName.match(/^Agent[-\s]*\d*$/i)) {
                        // å¦‚æœæ˜¯é»˜è®¤åç§°æˆ–ç©ºåç§°ï¼Œä½¿ç”¨æ›´å…·ä½“çš„åç§°
                        safeName = 'Agent' + (index + 1);
                    }
                    // ç§»é™¤å¸¸è§çš„å‰ç¼€
                    safeName = safeName.replace(/^(Agent|agent|ä»£ç†)[-\s]*/i, '');
                    if (!safeName) {
                        safeName = 'Agent' + (index + 1);
                    }
                    if (safeName.length > 25) {
                        safeName = safeName.substring(0, 22) + '...';
                    }
                    
                    // ä½¿ç”¨åœ†è§’é•¿æ–¹å½¢æ˜¾ç¤ºAgent
                    mermaidCode += '    ' + activity.id + '(' + safeName + ')\n';
                });
                
                // è¿æ¥AgentèŠ‚ç‚¹
                for (let i = 0; i < activities.length - 1; i++) {
                    mermaidCode += '    ' + activities[i].id + ' --> ' + activities[i + 1].id + '\n';
                }
                
                // åˆ›å»ºå·¥å…·èŠ‚ç‚¹ - ä½¿ç”¨æ–¹è§’é•¿æ–¹å½¢
                if (allTools.length > 0) {
                    allTools.forEach((tool, toolIndex) => {
                        // æ¸…ç†å·¥å…·åç§°ï¼Œç¡®ä¿ä½¿ç”¨å…·ä½“åç§°
                        let safeToolName = tool.name.replace(/[^\w\s\-\.\u4e00-\u9fff]/g, '').trim();
                        if (!safeToolName || safeToolName.match(/^Tool[-\s]*\d*$/i)) {
                            // å¦‚æœæ˜¯é»˜è®¤åç§°æˆ–ç©ºåç§°ï¼Œä½¿ç”¨æ›´æè¿°æ€§çš„åç§°
                            safeToolName = 'Tool' + (toolIndex + 1);
                        }
                        // ç§»é™¤å¸¸è§çš„å‰ç¼€
                        safeToolName = safeToolName.replace(/^(Tool|tool|Tool)[-\s]*/i, '');
                        if (!safeToolName) {
                            safeToolName = 'Tool' + (toolIndex + 1);
                        }
                        if (safeToolName.length > 20) {
                            safeToolName = safeToolName.substring(0, 17) + '...';
                        }
                        
                        // ä½¿ç”¨æ–¹è§’é•¿æ–¹å½¢æ˜¾ç¤ºTool
                        mermaidCode += '    ' + tool.id + '[' + safeToolName + ']\n';
                    });
                    
                    // è¿æ¥Agentå’Œå·¥å…· - ä½¿ç”¨è™šçº¿
                    allTools.forEach(tool => {
                        mermaidCode += '    ' + tool.agentId + ' -.-> ' + tool.id + '\n';
                        mermaidCode += '    ' + tool.id + ' -.-> ' + tool.agentId + '\n';
                    });
                }
                
                // è¿æ¥å¼€å§‹å’Œç»“æŸèŠ‚ç‚¹
                if (activities.length > 0) {
                    mermaidCode += '    Start --> ' + activities[0].id + '\n';
                    mermaidCode += '    ' + activities[activities.length-1].id + ' --> End([End])\n';
                }
                
                // æ³¨æ„ï¼šç‚¹å‡»äº‹ä»¶ç°åœ¨é€šè¿‡JavaScriptæ‰‹åŠ¨ç»‘å®šï¼Œä¸åœ¨Mermaidä»£ç ä¸­å£°æ˜
            }
            
            // æ·»åŠ æ ·å¼
            mermaidCode += '\n';
            mermaidCode += '    classDef agentNode fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#000,cursor:pointer\n';
            mermaidCode += '    classDef toolNode fill:#fff3e0,stroke:#f57c00,stroke-width:3px,color:#000,cursor:pointer\n';
            mermaidCode += '    classDef startEndNode fill:#e8f5e8,stroke:#4caf50,stroke-width:3px,color:#000\n';
            
            activities.forEach(activity => {
                mermaidCode += '    class ' + activity.id + ' agentNode\n';
            });
            allTools.forEach(tool => {
                mermaidCode += '    class ' + tool.id + ' toolNode\n';
            });
            mermaidCode += '    class Start,End startEndNode\n';
            
            console.log('ç”Ÿæˆçš„Mermaidä»£ç :', mermaidCode);
            
            // æ¸²æŸ“æµç¨‹å›¾
            if (typeof mermaid !== 'undefined') {
                // æ¸…é™¤ä¹‹å‰çš„å†…å®¹
                workflowContainer.innerHTML = '';
                
                // ä½¿ç”¨ç°ä»£çš„Mermaid API
                try {
                    const renderResult = await mermaid.render('workflow-graph-' + Date.now(), mermaidCode);
                    workflowContainer.innerHTML = renderResult.svg;
                    
                    // æ‰‹åŠ¨ç»‘å®šç‚¹å‡»äº‹ä»¶åˆ°SVGå…ƒç´ ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œå…¼å®¹Mermaidç”Ÿæˆçš„IDå‰ç¼€ï¼‰
                    const svgElement = workflowContainer.querySelector('svg');
                    if (svgElement) {
                        svgElement.style.cursor = 'pointer';
                        svgElement.addEventListener('click', function(event) {
                            const idChain = [];
                            let node = event.target;
                            let matched = false;

                            while (node && node !== svgElement) {
                                if (node.tagName && node.tagName.toLowerCase() === 'g' && node.id) {
                                    idChain.push(node.id);
                                    const rawId = node.id.replace(/^flowchart-/, '');
                                    // å»æ‰å¸¸è§çš„å‰ç¼€ï¼Œå¦‚ label- / node-
                                    const candidates = [rawId, rawId.replace(/^(label-|node-)/, '')];

                                    let activityNode = null;
                                    let toolNode = null;

                                    for (const rid of candidates) {
                                        activityNode = activities.find(a => rid === a.id || rid.startsWith(a.id + '-') || rid.endsWith('-' + a.id) || rid.includes('-' + a.id + '-'));
                                        if (activityNode) break;
                                    }
                                    if (activityNode) {
                                        jumpToActivityDetails(activityNode, 'agent', logs);
                                        matched = true;
                                        break;
                                    }

                                    for (const rid of candidates) {
                                        toolNode = allTools.find(t => rid === t.id || rid.startsWith(t.id + '-') || rid.endsWith('-' + t.id) || rid.includes('-' + t.id + '-'));
                                        if (toolNode) break;
                                    }
                                    if (toolNode) {
                                        jumpToActivityDetails(toolNode, 'tool', logs);
                                        matched = true;
                                        break;
                                    }
                                }
                                node = node.parentElement;
                            }

                            if (!matched) {
                                console.warn('Workflow click: no matching node found', {
                                    clickedTag: event.target.tagName,
                                    idChain: idChain,
                                    knownAgentIds: activities.map(a => a.id),
                                    knownToolIds: allTools.map(t => t.id)
                                });
                            }
                        });
                    }
                    
                    console.log('Mermaidæµç¨‹å›¾æ¸²æŸ“æˆåŠŸ');
                } catch (error) {
                    console.error('Mermaidæ¸²æŸ“å¤±è´¥:', error);
                    // å›é€€åˆ°æ—§çš„æ¸²æŸ“æ–¹æ³•
                    try {
                        const mermaidElement = document.createElement('div');
                        mermaidElement.className = 'mermaid';
                        mermaidElement.textContent = mermaidCode;
                        workflowContainer.appendChild(mermaidElement);
                        mermaid.init(undefined, mermaidElement);
                        console.log('ä½¿ç”¨å›é€€æ–¹æ³•æ¸²æŸ“æµç¨‹å›¾');
                        // å›é€€æ¸²æŸ“ååŒæ ·ç»‘å®šäº‹ä»¶ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
                        const svgElement = workflowContainer.querySelector('svg');
                        if (svgElement) {
                            svgElement.style.cursor = 'pointer';
                            svgElement.addEventListener('click', function(event) {
                                const idChain = [];
                                let node = event.target;
                                let matched = false;

                                while (node && node !== svgElement) {
                                    if (node.tagName && node.tagName.toLowerCase() === 'g' && node.id) {
                                        idChain.push(node.id);
                                        const rawId = node.id.replace(/^flowchart-/, '');
                                        const candidates = [rawId, rawId.replace(/^(label-|node-)/, '')];

                                        let activityNode = null;
                                        let toolNode = null;

                                        for (const rid of candidates) {
                                            activityNode = activities.find(a => rid === a.id || rid.startsWith(a.id + '-') || rid.endsWith('-' + a.id) || rid.includes('-' + a.id + '-'));
                                            if (activityNode) break;
                                        }
                                        if (activityNode) {
                                            jumpToActivityDetails(activityNode, 'agent', logs);
                                            matched = true;
                                            break;
                                        }

                                        for (const rid of candidates) {
                                            toolNode = allTools.find(t => rid === t.id || rid.startsWith(t.id + '-') || rid.endsWith('-' + t.id) || rid.includes('-' + t.id + '-'));
                                            if (toolNode) break;
                                        }
                                        if (toolNode) {
                                            jumpToActivityDetails(toolNode, 'tool', logs);
                                            matched = true;
                                            break;
                                        }
                                    }
                                    node = node.parentElement;
                                }

                                if (!matched) {
                                    console.warn('Workflow click: no matching node found (fallback)', {
                                        clickedTag: event.target.tagName,
                                        idChain: idChain,
                                        knownAgentIds: activities.map(a => a.id),
                                        knownToolIds: allTools.map(t => t.id)
                                    });
                                }
                            });
                        }
                    } catch (fallbackError) {
                        console.error('å›é€€æ¸²æŸ“ä¹Ÿå¤±è´¥:', fallbackError);
                        workflowContainer.innerHTML = 
                            '<div class="alert alert-warning">' +
                                '<i class="fas fa-exclamation-triangle"></i> Workflow rendering failed' +
                                '<br><small class="text-muted">Mermaidé”™è¯¯: ' + error.message + '</small>' +
                            '</div>';
                    }
                }
            } else {
                workflowContainer.innerHTML = 
                    '<div class="alert alert-info">' +
                        '<i class="fas fa-info-circle"></i> Mermaidåº“æœªåŠ è½½' +
                        '<br><small class="text-muted">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åå†è¯•</small>' +
                    '</div>';
            }
            
        } catch (error) {
            console.error('Workflow generation failed:', error);
            workflowContainer.innerHTML = 
                '<div class="alert alert-warning">' +
                    '<i class="fas fa-exclamation-triangle"></i> Workflow generation failed' +
                    '<br><small class="text-muted">é”™è¯¯: ' + error.message + '</small>' +
                '</div>';
        } finally {
            // éšè—åŠ è½½çŠ¶æ€
            loadingIndicator.style.display = 'none';
        }
        
        // æ³¨æ„ï¼šç‚¹å‡»äº‹ä»¶ç°åœ¨ç›´æ¥åœ¨SVGå…ƒç´ ä¸Šç»‘å®šï¼Œä¸éœ€è¦å…¨å±€å‡½æ•°
    }
    
    // è·³è½¬åˆ°å¯¹åº”çš„æ´»åŠ¨è¯¦æƒ…
    function jumpToActivityDetails(activity, type, logs) {
        console.log('è·³è½¬åˆ°æ´»åŠ¨è¯¦æƒ…:', type, activity);
        
        const historyItems = document.querySelectorAll('.history-item');
        let targetItem = null;
        
        // å®‰å…¨æ£€æŸ¥logsæ•°ç»„
        if (!logs || !Array.isArray(logs)) {
            console.error('æ— æ•ˆçš„logsæ•°ç»„:', logs);
            return;
        }
        
        // æ„å»ºæŸ¥æ‰¾å€™é€‰é¡¹åˆ—è¡¨ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº
        const candidates = [];
        
        if (type === 'agent') {
            // å¯¹äºAgentï¼Œä¼˜å…ˆçº§ï¼šè¾“å‡ºè®°å½• > è¾“å…¥è®°å½• > æ—¶é—´æˆ³åŒ¹é…
            
            // 1. é€šè¿‡outputLogIndexæŸ¥æ‰¾è¾“å‡ºè®°å½•ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
            if (activity.outputLogIndex !== undefined && 
                activity.outputLogIndex >= 0 && 
                activity.outputLogIndex < logs.length) {
                const targetLog = logs[activity.outputLogIndex];
                candidates.push({
                    targetType: 'agent_output',
                    targetTimestamp: targetLog.timestamp,
                    targetRoleName: targetLog.role_name,
                    targetLogIndex: activity.outputLogIndex,
                    priority: 1
                });
            }
            
            // 2. é€šè¿‡logIndexæŸ¥æ‰¾è¾“å…¥è®°å½•ï¼ˆä¸­ç­‰ä¼˜å…ˆçº§ï¼‰
            if (activity.logIndex !== undefined && 
                activity.logIndex >= 0 && 
                activity.logIndex < logs.length) {
                const targetLog = logs[activity.logIndex];
                candidates.push({
                    targetType: 'agent_input',
                    targetTimestamp: targetLog.timestamp,
                    targetRoleName: targetLog.role_name,
                    targetLogIndex: activity.logIndex,
                    priority: 2
                });
            }
            
            // 3. é€šè¿‡æ—¶é—´æˆ³åŒ¹é…ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰
            if (activity.outputTimestamp) {
                candidates.push({
                    targetType: 'agent_output',
                    targetTimestamp: activity.outputTimestamp,
                    targetRoleName: activity.originalName || activity.name,
                    targetLogIndex: activity.outputLogIndex,
                    priority: 3
                });
            }
            
            if (activity.timestamp) {
                candidates.push({
                    targetType: 'agent_input',
                    targetTimestamp: activity.timestamp,
                    targetRoleName: activity.originalName || activity.name,
                    targetLogIndex: activity.logIndex,
                    priority: 4
                });
            }
            
        } else if (type === 'tool') {
            // å¯¹äºToolï¼Œä¼˜å…ˆçº§ï¼šlogIndexæŸ¥æ‰¾ > æ—¶é—´æˆ³åŒ¹é…
            
            // 1. é€šè¿‡logIndexæŸ¥æ‰¾è¾“å…¥è®°å½•ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
            if (activity.logIndex !== undefined && 
                activity.logIndex >= 0 && 
                activity.logIndex < logs.length) {
                const targetLog = logs[activity.logIndex];
                candidates.push({
                    targetType: 'tool_input',
                    targetTimestamp: targetLog.timestamp,
                    targetRoleName: targetLog.role_name,
                    targetLogIndex: activity.logIndex,
                    priority: 1
                });
            }
            
            // 2. é€šè¿‡æ—¶é—´æˆ³åŒ¹é…ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
            if (activity.timestamp) {
                candidates.push({
                    targetType: 'tool_input',
                    targetTimestamp: activity.timestamp,
                    targetRoleName: activity.name,
                    targetLogIndex: activity.logIndex,
                    priority: 2
                });
            }
        }
        
        // æŒ‰ä¼˜å…ˆçº§æ’åºå€™é€‰é¡¹
        candidates.sort((a, b) => a.priority - b.priority);
        
        // éå†å€™é€‰é¡¹ï¼ŒæŒ‰ä¼˜å…ˆçº§æŸ¥æ‰¾åŒ¹é…é¡¹
        for (const candidate of candidates) {
            let foundForCandidate = false;

            // 1) å…ˆå°è¯•é€šè¿‡ä¸¥æ ¼çš„ logIndex åŒ¹é…ï¼ˆå”¯ä¸€ä¸”ç¨³å®šï¼‰
            if (candidate.targetLogIndex !== undefined && candidate.targetLogIndex !== null) {
                const strictMatch = Array.from(historyItems).find(item => 
                    item.dataset.type === candidate.targetType &&
                    item.dataset.logIndex !== undefined &&
                    Number(item.dataset.logIndex) === Number(candidate.targetLogIndex)
                );
                if (strictMatch) {
                    targetItem = strictMatch;
                    foundForCandidate = true;
                }
            }

            // 2) è‹¥æœªå‘½ä¸­ï¼ŒæŒ‰æ—¶é—´æˆ³ä¼˜å…ˆçº§åŒ¹é…ï¼›åŒç­‰æ¡ä»¶ä¸‹é€‰ä¸ç›®æ ‡ç´¢å¼•æœ€è¿‘çš„é¡¹
            if (!foundForCandidate) {
                let bestItem = null;
                let bestScore = Infinity;

                for (const item of historyItems) {
                    const timestamp = item.dataset.timestamp;
                    const itemType = item.dataset.type;
                    const roleName = item.dataset.roleName;

                    if (itemType !== candidate.targetType) continue;

                    const normalizeTs = (v) => (v == null ? '' : String(v).trim());
                    const tsItem = normalizeTs(timestamp);
                    const tsCand = normalizeTs(candidate.targetTimestamp);
                    const secPart = (s) => s.replace('T',' ').slice(0, 19);
                    const tsEqual = tsItem && tsCand && tsItem === tsCand;
                    const tsEqualSec = tsItem && tsCand && secPart(tsItem) === secPart(tsCand);
                    let tsNear = false;
                    try {
                        const ti = Date.parse(tsItem);
                        const tc = Date.parse(tsCand);
                        if (!isNaN(ti) && !isNaN(tc)) {
                            tsNear = Math.abs(ti - tc) <= 2000; // 2 ç§’å®¹å·®
                        }
                    } catch (_) {}

                    const roleMatch = candidate.targetRoleName && roleName && roleName === candidate.targetRoleName;

                    let quality = null;
                    if (tsEqual) quality = 0;
                    else if (tsEqualSec) quality = 1;
                    else if (tsNear) quality = 2;
                    else if (roleMatch) quality = 3;

                    if (quality !== null) {
                        let distance = 999999;
                        if (candidate.targetLogIndex !== undefined && candidate.targetLogIndex !== null && item.dataset.logIndex !== undefined) {
                            distance = Math.abs(Number(item.dataset.logIndex) - Number(candidate.targetLogIndex));
                        }
                        const score = quality * 100000 + distance;
                        if (score < bestScore) {
                            bestScore = score;
                            bestItem = item;
                        }
                    }
                }

                if (bestItem) {
                    targetItem = bestItem;
                    foundForCandidate = true;
                }
            }

            if (foundForCandidate) break; // æ‰¾åˆ°ç›®æ ‡é¡¹å°±è·³å‡º
        }
        
        if (!targetItem) {
            console.warn('No matching history record item found (after all strategies):', {
                type,
                activity,
                candidatesCount: candidates.length,
                candidates,
                availableItems: Array.from(historyItems).map(el => ({ type: el.dataset.type, ts: el.dataset.timestamp, role: el.dataset.roleName }))
            });
        }
        
        if (targetItem) {
            // æ¸…é™¤å½“å‰æ´»åŠ¨é¡¹
            document.querySelectorAll('.history-item').forEach(item => item.classList.remove('active'));
            
            // æ¿€æ´»ç›®æ ‡é¡¹
            targetItem.classList.add('active');
            
            // æ»šåŠ¨åˆ°ç›®æ ‡é¡¹
            targetItem.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            // è§¦å‘ç‚¹å‡»äº‹ä»¶ä»¥æ˜¾ç¤ºè¯¦æƒ…
            setTimeout(() => {
                targetItem.click();
            }, 300);
        } else {
            console.warn('No matching history record item found:', {
                type: type,
                activity: activity,
                candidatesCount: candidates.length,
                candidates: candidates
            });
        }
    }
    
    // è·å–æœ€æ–°æ•°æ®
    async function fetchLatestData(forceUpdate = false, skipHistoryUpdate = false) {
        try {
            const paths = window.location.pathname.split('/')
            const taskId = paths[paths.length - 1];
            const response = await fetch('/api/task/' + taskId + '/logs?timestamp=' + Date.now());
            
            if (response.ok) {
                const data = await response.json();
                console.log('Get task data, status: ' + data.task.status + ', log number: ' + data.logs.length + ', force update: ' + forceUpdate);
                
                // è°ƒè¯•æ—¥å¿—æ•°æ®ï¼ˆå·²ç§»é™¤ä»¥å‡å°‘æ§åˆ¶å°å™ªéŸ³ï¼‰
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®å˜åŒ–
                const hasStatusChange = !currentTaskData || data.task.status !== currentTaskData.task.status;
                const hasLogChange = !currentTaskData || data.logs.length !== currentTaskData.logs.length;
                
                // ä¼˜åŒ–å†…å®¹å˜åŒ–æ£€æµ‹ - æ›´ä¸¥æ ¼çš„å˜åŒ–æ£€æµ‹
                let hasContentChange = false;
                if (!currentTaskData) {
                    hasContentChange = true;
                } else if (data.logs.length > 0 && currentTaskData.logs.length > 0 && data.logs.length === currentTaskData.logs.length) {
                    // åªæœ‰åœ¨æ—¥å¿—æ•°é‡ç›¸åŒæ—¶æ‰æ£€æŸ¥å†…å®¹å˜åŒ–ï¼Œé¿å…é‡å¤æ£€æµ‹
                    const newLastLog = data.logs[data.logs.length - 1];
                    const oldLastLog = currentTaskData.logs[currentTaskData.logs.length - 1];
                    hasContentChange = newLastLog.timestamp !== oldLastLog.timestamp || 
                                     newLastLog.content !== oldLastLog.content;
                } else if (data.logs.length !== currentTaskData.logs.length) {
                    hasContentChange = true; // æ•°é‡å˜åŒ–ä¹Ÿç®—å†…å®¹å˜åŒ–
                }
                
                // å¦‚æœæ˜¯åˆæ¬¡åŠ è½½æˆ–å¼ºåˆ¶æ›´æ–°ï¼Œæˆ–è€…æ•°æ®ç¡®å®å‘ç”Ÿäº†å˜åŒ–
                if (forceUpdate || !currentTaskData || hasStatusChange || hasLogChange || hasContentChange) {
                    
                    console.log('Data changed, update interface:', {
                        forceUpdate,
                        hasStatusChange,
                        hasLogChange,
                        hasContentChange,
                        newLogCount: data.logs.length,
                        oldLogCount: currentTaskData ? currentTaskData.logs.length : 0
                    });
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    if (hasStatusChange) {
                        updateTaskStatus(data.task.status);
                    }
                    
                    // æ›´æ–°å†å²è®°å½•å’Œæµç¨‹å›¾ - åªæœ‰åœ¨æœ‰æ—¥å¿—å˜åŒ–æˆ–å¼ºåˆ¶æ›´æ–°æ—¶æ‰æ›´æ–°
                    if ((forceUpdate || hasLogChange || hasContentChange) && !skipHistoryUpdate) {
                        console.log('Trigger history record update...');
                        updateHistoryList(data.logs);
                        await generateWorkflowChart(data.logs);
                    } else if (skipHistoryUpdate) {
                        console.log('Skip history record update (skipHistoryUpdate=true)');
                        // å³ä½¿è·³è¿‡å†å²è®°å½•æ›´æ–°ï¼Œä¹Ÿè¦æ›´æ–°æµç¨‹å›¾
                        await generateWorkflowChart(data.logs);
                    } else {
                        console.log('Skip history record update (no related changes)');
                    }
                    
                    currentTaskData = data;
                    
                    // æ›´æ–°æœ€ç»ˆæ‰§è¡Œç»“æœ
                    if (data.task.result && data.task.status === 'completed') {
                        const resultContainer = document.getElementById('final-result-content');
                        if (resultContainer && (!resultContainer.innerHTML || resultContainer.innerHTML.includes('<!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ¸²æŸ“ -->'))) {
                            console.log('ğŸ“ Update final execution result...');
                            const renderedResult = renderContent(data.task.result, 'agent_output');
                            resultContainer.innerHTML = renderedResult;
                            console.log('âœ… Final execution result updated');
                        }
                    }
                } else {
                    console.log('No data change, skip update');
                }
                
                return data;
            } else {
                console.error('Get data failed, HTTP status:', response.status);
            }
        } catch (error) {
            console.error('Get latest data failed:', error);
        }
        return null;
    }
    
    // è‡ªåŠ¨åˆ·æ–°é€»è¾‘
    function startAutoRefresh() {
        // ç¡®ä¿æ²¡æœ‰é‡å¤çš„å®šæ—¶å™¨
        if (refreshInterval) {
            console.log('Clear existing timer');
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
        
        console.log('ğŸ”„ Start auto refresh timer - check update every 5 seconds');
        let refreshCount = 0;
        
        refreshInterval = setInterval(async () => {
            try {
                refreshCount++;
                console.log(`ğŸ“¡ Auto refresh #${refreshCount}:`, new Date().toLocaleTimeString());
                
                showRefreshIndicator();
                const data = await fetchLatestData();
                
                if (!data) {
                    console.warn('âš ï¸ Get data failed, will retry next time');
                    return;
                }
                
                // å¦‚æœä»»åŠ¡å·²å®Œæˆæˆ–å¤±è´¥ï¼Œåœæ­¢è‡ªåŠ¨åˆ·æ–°
                if (data.task.status === 'completed' || data.task.status === 'failed') {
                    console.log('âœ… Task status changed to ' + data.task.status + ', stop auto refresh');
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                    
                    // æ›´æ–°åˆ·æ–°æŒ‡ç¤ºå™¨æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
                    const indicator = document.getElementById('refresh-indicator');
                    if (indicator) {
                        indicator.textContent = 'âœ… Task completed';
                        indicator.classList.add('active');
                        setTimeout(() => indicator.classList.remove('active'), 3000);
                    }
                }
            } catch (error) {
                console.error('âŒ Error during auto refresh:', error);
            }
        }, 5000); // 5 seconds refresh once, reduce frequency to avoid repeated problems
        
        console.log('âœ… Auto refresh timer started');
    }
    
    // å†å²è®°å½•ç‚¹å‡»äº‹ä»¶
    document.addEventListener('click', function(e) {
        const historyItem = e.target.closest('.history-item');
        if (historyItem) {
            document.querySelectorAll('.history-item').forEach(item => item.classList.remove('active'));
            historyItem.classList.add('active');
            
            const type = historyItem.dataset.type;
            const content = historyItem.dataset.content;
            const timestamp = historyItem.dataset.timestamp;
            const specificName = historyItem.dataset.roleName;
            
            let title = '';
            if (type === 'agent_input') {
                title = (specificName ? specificName : 'Agent') + ' input - ' + timestamp;
            } else if (type === 'agent_output') {
                title = (specificName ? specificName : 'Agent') + ' output - ' + timestamp;
            } else if (type === 'tool_input') {
                title = (specificName ? specificName : 'Tool') + ' call - ' + timestamp;
            } else if (type === 'tool_output') {
                title = (specificName ? specificName : 'Tool') + ' result - ' + timestamp;
            } else {
                title = type + ' - ' + timestamp;
            }
            
            let detailHtml = renderContent(content, type);
            
            document.getElementById('detail-title').textContent = title;
            document.getElementById('detail-content').innerHTML = detailHtml;
            
            // å½“ tool_output çš„å†…å®¹ä¸º JSON ä¸”åŒ…å« calculate_path æ—¶ï¼Œæ³¨å…¥å¿«æ·é“¾æ¥
            if (type === 'tool_output') {
                try {
                    const data = JSON.parse(content);
                    const basePathRaw = data && (data.calculate_path || data.calc_path || data.calculation_path);
                    if (basePathRaw && typeof basePathRaw === 'string' && basePathRaw.trim() !== '') {
                        const basePath = basePathRaw.endsWith('/') ? basePathRaw.slice(0, -1) : basePathRaw;
                        const incarPath = basePath + '/INCAR';
                        const kpointsPath = basePath + '/KPOINTS';
                        const outcarPath = basePath + '/OUTCAR';
                        
                        const linksContainer = document.createElement('div');
                        linksContainer.className = 'mt-3';
                        linksContainer.innerHTML =
                            '<div class="small text-muted mb-2">è®¡ç®—ç›®å½•: <code class="file-path">' + basePath + '</code></div>' +
                            '<div>' +
                                '<a href="#" class="btn btn-sm btn-outline-secondary me-2" onclick="showTextFile(decodeURIComponent(\'' + encodeURIComponent(incarPath) + '\'))">' +
                                    '<i class="fas fa-file-alt"></i> æŸ¥çœ‹ INCAR</a>' +
                                '<a href="#" class="btn btn-sm btn-outline-secondary me-2" onclick="showTextFile(decodeURIComponent(\'' + encodeURIComponent(kpointsPath) + '\'))">' +
                                    '<i class="fas fa-file-alt"></i> æŸ¥çœ‹ KPOINTS</a>' +
                                '<a href="#" class="btn btn-sm btn-outline-info" onclick="downloadByFilePath(decodeURIComponent(\'' + encodeURIComponent(outcarPath) + '\'))">' +
                                    '<i class="fas fa-download"></i> ä¸‹è½½ OUTCAR</a>' +
                            '</div>';
                        const detailEl = document.getElementById('detail-content');
                        detailEl.appendChild(linksContainer);
                    }
                } catch (e) { /* é JSON å¿½ç•¥ */ }
            }
            
            if (window.Prism) {
                Prism.highlightAll();
            }
        }
    });
    
    // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶çš„å¤„ç†
    document.addEventListener('visibilitychange', async function() {
        if (document.hidden) {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        } else {
            // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œæ£€æŸ¥ä»»åŠ¡çŠ¶æ€å†å†³å®šæ˜¯å¦é‡æ–°å¼€å§‹åˆ·æ–°
            if (!refreshInterval) {
                const data = await fetchLatestData(false); // ä¸å¼ºåˆ¶æ›´æ–°ï¼Œé¿å…ä¸å¿…è¦çš„çŠ¶æ€é—ªçƒ
                if (data && data.task.status !== 'completed' && data.task.status !== 'failed') {
                    console.log('Page reappeared, task status: ' + data.task.status + ', restart auto refresh');
                    startAutoRefresh();
                } else {
                    console.log('Page reappeared, task status: ' + (data?.task.status || 'Unknown') + ', no auto refresh');
                }
            }
        }
    });
    
    // å…¨å±€å˜é‡
    let jsmolApplets = {};
    let currentTaskId = null;
    
    // è·å–å½“å‰ä»»åŠ¡ID
    function getCurrentTaskId() {
        if (!currentTaskId) {
            currentTaskId = window.location.pathname.split('/')[2];
        }
        return currentTaskId;
    }
    
    // åˆå§‹åŒ–JSMol
    function initializeJSMol() {
        if (typeof Jmol !== 'undefined') {
            Jmol.setDocument(document);
            console.log('JSMol initialized');
        }
    }
    
    // æ„å»ºæ–‡ä»¶ API URLï¼ˆæ”¯æŒç»å¯¹è·¯å¾„ï¼‰
    function buildFileApiUrl(filePath) {
        const taskId = getCurrentTaskId();
        let processedPath = filePath || '';
        if (processedPath.startsWith('/')) {
            processedPath = '__ABS__' + processedPath;
        }
        const pathSegments = processedPath.split('/');
        const encodedSegments = pathSegments.map(segment => encodeURIComponent(segment));
        const encodedPath = encodedSegments.join('/');
        return '/api/files/' + taskId + '/' + encodedPath;
    }

    function getFileName(filePath) {
        if (!filePath) return 'file.txt';
        const parts = filePath.split('/');
        return parts[parts.length - 1] || 'file.txt';
    }

    // ä»¥æ–‡æœ¬æ–¹å¼å±•ç¤ºæ–‡ä»¶å†…å®¹
    function showTextFile(filePath) {
        const displayArea = document.getElementById('file-display-area');
        const displayTitle = document.getElementById('file-display-title');
        const displayContent = document.getElementById('file-display-content');

        const apiUrl = buildFileApiUrl(filePath);

        displayTitle.innerHTML = '<i class="fas fa-file-alt"></i> æ–‡ä»¶å†…å®¹: ' + filePath;
        displayContent.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <div class="mt-2">åŠ è½½æ–‡ä»¶å†…å®¹...</div>
            </div>
        `;
        displayArea.style.display = 'block';
        displayArea.scrollIntoView({ behavior: 'smooth' });

        fetch(apiUrl)
            .then(resp => {
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                return resp.text();
            })
            .then(text => {
                displayContent.innerHTML = '';
                const toolbar = document.createElement('div');
                toolbar.className = 'mb-2';
                toolbar.innerHTML = '<button class="btn btn-sm btn-outline-info" onclick="downloadByFilePath(\'' + filePath.replace(/'/g, "\\'") + '\')">' +
                                    '<i class="fas fa-download"></i> ä¸‹è½½</button>';
                const pre = document.createElement('pre');
                pre.className = 'mb-0';
                const code = document.createElement('code');
                code.textContent = text;
                pre.appendChild(code);
                displayContent.appendChild(toolbar);
                displayContent.appendChild(pre);
                if (window.Prism) {
                    Prism.highlightAll();
                }
            })
            .catch(err => {
                displayContent.innerHTML = 
                    '<div class="alert alert-danger">' +
                        'âŒ æ–‡ä»¶åŠ è½½å¤±è´¥: ' + err.message + '<br>' +
                        '<small class="text-muted">' + apiUrl + '</small>' +
                    '</div>';
            });
    }

    // é€šè¿‡æ–‡ä»¶è·¯å¾„ä¸‹è½½
    function downloadByFilePath(filePath) {
        const url = buildFileApiUrl(filePath);
        downloadFile(url, getFileName(filePath));
    }
    
    // æ˜¾ç¤ºå›¾ç‰‡æ–‡ä»¶
    function showImageFile(filePath, buttonId) {
        const taskId = getCurrentTaskId();
        const displayArea = document.getElementById('file-display-area');
        const displayTitle = document.getElementById('file-display-title');
        const displayContent = document.getElementById('file-display-content');
        
        // å¯¹æ–‡ä»¶è·¯å¾„è¿›è¡Œå®‰å…¨ç¼–ç ï¼Œç‰¹åˆ«å¤„ç†ç»å¯¹è·¯å¾„
        let processedPath = filePath;
        
        // å¦‚æœæ˜¯ç»å¯¹è·¯å¾„ï¼Œæ·»åŠ ç‰¹æ®Šæ ‡è®°æ¥ä¿æŠ¤å¼€å¤´çš„ /
        if (filePath.startsWith('/')) {
            processedPath = '__ABS__' + filePath;
        }
        
        // å°†è·¯å¾„åˆ†æ®µï¼Œé€æ®µç¼–ç ï¼Œç„¶åé‡æ–°ç»„åˆ
        const pathSegments = processedPath.split('/');
        const encodedSegments = pathSegments.map(segment => encodeURIComponent(segment));
        const encodedPath = encodedSegments.join('/');
        const apiUrl = '/api/files/' + taskId + '/' + encodedPath;
        
        console.log('Original path:', filePath);
        console.log('Processed path:', processedPath);
        console.log('Encoded path:', encodedPath);
        console.log('Full API URL:', apiUrl);
        
        // æ›´æ–°æ ‡é¢˜
        displayTitle.innerHTML = '<i class="fas fa-image"></i> Image preview: ' + filePath;
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        displayContent.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <div class="mt-2">Loading image...</div>
            </div>
        `;
        
        // æ˜¾ç¤ºæ˜¾ç¤ºåŒºåŸŸ
        displayArea.style.display = 'block';
        displayArea.scrollIntoView({ behavior: 'smooth' });
        
        // åŠ è½½å›¾ç‰‡
        const img = new Image();
        img.onload = function() {
            displayContent.innerHTML = 
                '<div class="text-center">' +
                    '<img src="' + apiUrl + '" class="content-image" alt="' + filePath + '">' +
                    '<div class="mt-2">' +
                        '<small class="text-muted">File path: ' + filePath + '</small>' +
                    '</div>' +
                '</div>';
            console.log('Image loaded successfully:', filePath);
        };
        
        img.onerror = function() {
            displayContent.innerHTML = 
                '<div class="alert alert-warning">' +
                    '<i class="fas fa-exclamation-triangle"></i> Failed to load image' +
                    '<br><strong>File path:</strong> ' + filePath +
                    '<br><strong>API URL:</strong> ' + apiUrl +
                    '<br><small class="text-muted">Please check if the file exists or the path is correct</small>' +
                '</div>';
            console.error('Image loading failed:', filePath);
        };
        
        img.src = apiUrl;
    }
    
    // æ˜¾ç¤ºVASPæ™¶ä½“ç»“æ„æ–‡ä»¶
    function showVaspFile(filePath, buttonId) {
        const taskId = getCurrentTaskId();
        const displayArea = document.getElementById('file-display-area');
        const displayTitle = document.getElementById('file-display-title');
        const displayContent = document.getElementById('file-display-content');
        
        // å¯¹æ–‡ä»¶è·¯å¾„è¿›è¡Œå®‰å…¨ç¼–ç ï¼Œç‰¹åˆ«å¤„ç†ç»å¯¹è·¯å¾„
        let processedPath = filePath;
        
        // å¦‚æœæ˜¯ç»å¯¹è·¯å¾„ï¼Œæ·»åŠ ç‰¹æ®Šæ ‡è®°æ¥ä¿æŠ¤å¼€å¤´çš„ /
        if (filePath.startsWith('/')) {
            processedPath = '__ABS__' + filePath;
        }
        
        // å°†è·¯å¾„åˆ†æ®µï¼Œé€æ®µç¼–ç ï¼Œç„¶åé‡æ–°ç»„åˆ
        const pathSegments = processedPath.split('/');
        const encodedSegments = pathSegments.map(segment => encodeURIComponent(segment));
        const encodedPath = encodedSegments.join('/');
        const apiUrl = '/api/files/' + taskId + '/' + encodedPath;
        
        console.log('Original path:', filePath);
        console.log('Processed path:', processedPath);
        console.log('Encoded path:', encodedPath);
        console.log('Full API URL:', apiUrl);
        
        // æ›´æ–°æ ‡é¢˜
        displayTitle.innerHTML = '<i class="fas fa-cube"></i> æ™¶ä½“ç»“æ„: ' + filePath;
        
        // åˆ›å»ºJSMolå®¹å™¨
        const jsmolId = 'jsmol_display_' + Date.now();
        displayContent.innerHTML = 
            '<div class="jsmol-container">' +
                '<div class="text-center mb-3">' +
                    '<h6>Crystal structure visualization</h6>' +
                    '<small class="text-muted">File: ' + filePath + '</small>' +
                '</div>' +
                '<div id="' + jsmolId + '" style="width: 500px; height: 500px; margin: 0 auto; background-color: #fff; border: 1px solid #ccc; border-radius: 5px;"></div>' +
                '<div class="mt-3">' +
                    '<button class="btn btn-sm btn-primary" onclick="loadVaspStructure(\'' + jsmolId + '\', \'' + apiUrl + '\')">' +
                        '<i class="fas fa-play"></i> load structure' +
                    '</button>' +
                    '<button class="btn btn-sm btn-secondary ms-2" onclick="resetVaspView(\'' + jsmolId + '\')">' +
                        '<i class="fas fa-redo"></i> reset view' +
                    '</button>' +
                    '<button class="btn btn-sm btn-info ms-2" onclick="downloadFile(\'' + apiUrl + '\', \'' + filePath + '\')">' +
                        '<i class="fas fa-download"></i> download file' +
                    '</button>' +
                '</div>' +
            '</div>';
        
        // æ˜¾ç¤ºæ˜¾ç¤ºåŒºåŸŸ
        displayArea.style.display = 'block';
        displayArea.scrollIntoView({ behavior: 'smooth' });
        
        console.log('Prepare to display VASP structure:', filePath);
    }
    
    // å…³é—­æ–‡ä»¶æ˜¾ç¤ºåŒºåŸŸ
    function closeFileDisplay() {
        const displayArea = document.getElementById('file-display-area');
        displayArea.style.display = 'none';
        
        // æ¸…ç†JSMolå®ä¾‹
        const displayContent = document.getElementById('file-display-content');
        displayContent.innerHTML = '';
        
        console.log('Close file display area');
    }
    
    // ä¸‹è½½æ–‡ä»¶
    function downloadFile(url, filename) {
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // åŠ è½½VASPæ™¶ä½“ç»“æ„
    function loadVaspStructure(containerId, fileUrl) {
        if (typeof Jmol === 'undefined') {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        âš ï¸ JSMol not loaded, please try again later
                        <br><small class="text-muted">JSMol is loading from CDN...</small>
                    </div>
                `;
            }
            return;
        }
        
        const container = document.getElementById(containerId);
        if (!container) {
            console.error('JSMol container not found:', containerId);
            return;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        container.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <div class="mt-2">Loading crystal structure...</div>
            </div>
        `;
        
        // ç¡®å®šJSMolå®¹å™¨çš„å°ºå¯¸
        const containerWidth = container.style.width ? parseInt(container.style.width) : 500;
        const containerHeight = container.style.height ? parseInt(container.style.height) : 500;
        
        // JSMolåº”ç”¨ç¨‹åºé…ç½®
        const jsmolInfo = {
            width: containerWidth,
            height: containerHeight,
            debug: false,
            color: "white",
            addSelectionOptions: false,
            use: "HTML5",
            j2sPath: "https://chemapps.stolaf.edu/jmol/jsmol/j2s",
            readyFunction: function(applet) {
                console.log('JSMol applet ' + applet._id + ' ready, load file: ' + fileUrl);
            },
            script: 
                'load "' + fileUrl + '";' +
                'if (_loadScript.error) {' +
                    'print "File loading failed: ' + fileUrl + '";' +
                    'background white;' +
                    'color red;' +
                    'set echo top center;' +
                    'echo "File loading failed";' +
                '} else {' +
                    'spacefill 20%;' +
                    'wireframe 0.15;' +
                    'axes on;' +
                    'unitcell on;' +
                    'rotate best;' +
                    'zoom 100;' +
                    'background white;' +
                '}'
        };
        
        try {
            setTimeout(() => {
                // åˆ›å»ºJSMolåº”ç”¨ç¨‹åº
                const appletName = 'jsmolApplet_' + containerId;
                const appletHtml = Jmol.getAppletHtml(appletName, jsmolInfo);
                container.innerHTML = appletHtml;
                jsmolApplets[containerId] = appletName;
                
                console.log('Loading crystal structure: ' + fileUrl);
            }, 100);
        } catch (error) {
            console.error('Loading crystal structure failed:', error);
            container.innerHTML = 
                '<div class="alert alert-danger">' +
                    'âŒ Loading crystal structure failed: ' + error.message +
                    '<br><small class="text-muted">Please check if the file exists: ' + fileUrl + '</small>' +
                    '<div class="mt-2">' +
                        '<button class="btn btn-sm btn-outline-primary" onclick="downloadFile(\'' + fileUrl + '\', \'structure.vasp\')">' +
                            '<i class="fas fa-download"></i> download file to view' +
                        '</button>' +
                    '</div>' +
                            '</div>';
        }
    }
    
    // é‡ç½®JSMolè§†å›¾
    function resetVaspView(containerId) {
        const appletName = jsmolApplets[containerId];
        if (appletName && typeof Jmol !== 'undefined') {
            try {
                Jmol.script(appletName, "rotate best; zoom 100; center;");
                console.log('Reset crystal structure view');
            } catch (error) {
                console.error('Reset view failed:', error);
            }
        }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹è‡ªåŠ¨åˆ·æ–°
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('ğŸš€ Start initializing Task detail page...');
        
        // åˆå§‹åŒ–Markedé…ç½®
        if (typeof marked !== 'undefined') {
            marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false
            });
            console.log('âœ… Marked initialized');
        } else {
            console.warn('âš ï¸ Marked library not loaded');
        }
        
        // åˆå§‹åŒ–Mermaid
        if (typeof mermaid !== 'undefined') {
            mermaid.initialize({ 
                startOnLoad: false, // æ‰‹åŠ¨æ§åˆ¶åˆå§‹åŒ–
                theme: 'default',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true,
                    curve: 'basis'
                },
                securityLevel: 'loose', // å…è®¸ç‚¹å‡»äº‹ä»¶
                themeVariables: {
                    primaryColor: '#e3f2fd',
                    primaryTextColor: '#000',
                    primaryBorderColor: '#1976d2',
                    lineColor: '#333',
                    sectionBkgColor: '#f8f9fa',
                    altSectionBkgColor: '#fff',
                    gridColor: '#e0e0e0'
                }
            });
            console.log('âœ… Mermaid initialized (version: ' + mermaid.version + ')');
        } else {
            console.warn('âš ï¸ Mermaid library not loaded');
        }
        
        // åˆå§‹åŒ–JSMol
        initializeJSMol();
        
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰é™æ€æ¸²æŸ“çš„å†å²è®°å½•
        const existingHistoryItems = document.querySelectorAll('.history-item');
        const hasStaticContent = existingHistoryItems.length > 0;
        
        console.log(`ğŸ“¡ Start getting initial data... (detected ${hasStaticContent ? 'has' : 'no'} static content, currently ${existingHistoryItems.length} history items)`);
        
        // åˆå§‹åŒ–è·å–ä¸€æ¬¡æ•°æ®ï¼Œå¦‚æœæœ‰é™æ€å†…å®¹å°±è·³è¿‡å†å²è®°å½•æ›´æ–°ä»¥é¿å…é‡å¤
        const initialData = await fetchLatestData(true, hasStaticContent);
        
        if (!initialData) {
            console.error('âŒ Failed to get initial data');
            return;
        }
        
        console.log('âœ… Initial data obtained successfully:', {
            status: initialData.task.status,
            logCount: initialData.logs.length,
            hasStaticContent: hasStaticContent
        });
        
        // åªæœ‰åœ¨æ²¡æœ‰é™æ€å†…å®¹æ—¶æ‰éœ€è¦æ‰‹åŠ¨æ›´æ–°å†å²è®°å½•
        // å¦‚æœæœ‰é™æ€å†…å®¹ï¼ŒfetchLatestDataå·²ç»è·³è¿‡äº†å†å²æ›´æ–°ï¼Œè¿™é‡Œä¹Ÿä¸éœ€è¦å†æ›´æ–°
        if (!hasStaticContent) {
            console.log('ğŸ”„ Update history record list (no static content)...');
            updateHistoryList(initialData.logs);
        } else {
            console.log('â­ï¸ Skip history record update (using static rendering content)');
            // ä¿å­˜å½“å‰æ•°æ®ä¾›åç»­æ¯”è¾ƒ
            currentTaskData = initialData;
        }
        
        // ç”Ÿæˆåˆå§‹æµç¨‹å›¾
        if (initialData && initialData.logs) {
            console.log('ğŸ¨ Start generating initial workflow chart...');
            await generateWorkflowChart(initialData.logs);
        }
        
        // æ¸²æŸ“æœ€ç»ˆæ‰§è¡Œç»“æœ
        const resultContainer = document.getElementById('final-result-content');
        if (resultContainer) {
            // ä¼˜å…ˆä½¿ç”¨APIæ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ£€æŸ¥æ˜¯å¦æœ‰é™æ€æ•°æ®
            let resultData = null;
            if (initialData && initialData.task.result) {
                resultData = initialData.task.result;
                console.log('ğŸ“ Use API data to render final execution result...');
            } else {
                // æ£€æŸ¥æ˜¯å¦æœ‰é™æ€çš„task.resultæ•°æ®ï¼ˆé€šè¿‡Jinja2æ¨¡æ¿ä¼ é€’çš„ï¼‰
                const staticResultElement = document.querySelector('[data-static-result]');
                if (staticResultElement) {
                    resultData = staticResultElement.getAttribute('data-static-result');
                    console.log('ğŸ“ Use static data to render final execution result...');
                }
            }
            
            if (resultData) {
                const renderedResult = renderContent(resultData, 'agent_output');
                resultContainer.innerHTML = renderedResult;
                console.log('âœ… Final execution result rendered');
            }
        }
        
        // åªæœ‰å½“ä»»åŠ¡è¿˜åœ¨è¿è¡Œæˆ–ç­‰å¾…æ—¶æ‰å¼€å§‹è‡ªåŠ¨åˆ·æ–°
        if (initialData && initialData.task.status !== 'completed' && initialData.task.status !== 'failed') {
            console.log('ğŸ”„ Task status: ' + initialData.task.status + ', start auto refresh');
            startAutoRefresh();
        } else {
            console.log('â¹ï¸ Task status: ' + (initialData?.task.status || 'Unknown') + ', no auto refresh');
            // æ¸…ç†å¯èƒ½å­˜åœ¨çš„å®šæ—¶å™¨
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        // åˆå§‹åŒ–åœæ­¢æŒ‰é’®çŠ¶æ€
        if (initialData && initialData.task) {
            updateStopButton(initialData.task.status);
        }
        
        console.log('ğŸ‰ Task detail page initialized!');
    });
    
    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    });
    
    // å…¨å±€å‡½æ•°ï¼Œä¾›HTML onclickè°ƒç”¨
    window.loadVaspStructure = loadVaspStructure;
    window.resetVaspView = resetVaspView;
    window.showImageFile = showImageFile;
    window.showVaspFile = showVaspFile;
    window.closeFileDisplay = closeFileDisplay;
    window.downloadFile = downloadFile;
    window.stopTask = stopTask;
    window.showTextFile = showTextFile;
    window.downloadByFilePath = downloadByFilePath;
    </script>
</body>
</html> 