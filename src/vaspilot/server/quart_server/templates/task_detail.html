<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css" rel="stylesheet">
    <!-- FontAwesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <!-- JSMol for crystal structure visualization -->
    <script src="https://chemapps.stolaf.edu/jmol/jsmol/JSmol.min.js"></script>
    <!-- Mermaid for flowcharts -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        /* Âü∫Á°ÄÂ≠ó‰ΩìÂ§ßÂ∞èËÆæÁΩÆ */
        body { font-size: 16px; }
        p, .card-text, .text-muted, small { font-size: 1.1em; }
        .lead { font-size: 1.3em; }
        h1, h2, h3, h4, h5, h6 { font-size: 1.2em; }
        
        .sidebar { height: 100vh; overflow-y: auto; border-right: 1px solid #dee2e6; }
        .main-content { height: 100vh; overflow-y: auto; }
        .task-card { cursor: pointer; transition: all 0.2s; }
        .task-card:hover { background-color: #f8f9fa; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .task-card.active { background-color: #e3f2fd; border-left: 4px solid #1976d2; }
        .status-badge { font-size: 0.9em; }
        .log-entry { font-family: 'Courier New', monospace; font-size: 1em; padding: 8px; margin: 2px 0; border-radius: 4px; background-color: #f8f9fa; border-left: 3px solid #6c757d; }
        .log-entry.info { border-left-color: #17a2b8; }
        .log-entry.warning { border-left-color: #ffc107; }
        .log-entry.error { border-left-color: #dc3545; }
        .agent-activity { padding: 12px; margin: 5px 0; border-radius: 6px; border: 1px solid #ddd; font-size: 1.05em; }
        .agent-input { background-color: #e8f5e8; border-left: 4px solid #28a745; }
        .agent-output { background-color: #fff3cd; border-left: 4px solid #ffc107; }
        .tool-activity { padding: 12px; margin: 5px 0; border-radius: 6px; border: 1px solid #ddd; font-family: 'Courier New', monospace; font-size: 0.95em; }
        .tool-input { background-color: #f8d7da; border-left: 4px solid #dc3545; }
        .tool-output { background-color: #d1ecf1; border-left: 4px solid #17a2b8; }
        pre { white-space: pre-wrap; word-wrap: break-word; font-size: 1em; }
        .history-item.active { background-color: #e3f2fd; }
        
        /* Ëá™Âä®Âà∑Êñ∞ÊèêÁ§∫ */
        .refresh-indicator { 
            position: fixed; 
            top: 10px; 
            right: 10px; 
            background: rgba(0,0,0,0.7); 
            color: white; 
            padding: 5px 10px; 
            border-radius: 15px; 
            font-size: 0.8em; 
            display: none; 
            z-index: 1000; 
        }
        .refresh-indicator.active { display: block; }
        
        /* MarkdownÂÜÖÂÆπÊ†∑Âºè */
        .markdown-content { 
            font-size: 1.05em; 
            line-height: 1.6; 
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { 
            margin-top: 1em; 
            margin-bottom: 0.5em; 
        }
        .markdown-content p { 
            margin-bottom: 0.8em; 
        }
        .markdown-content code { 
            background-color: #f8f9fa; 
            padding: 2px 4px; 
            border-radius: 3px; 
            font-size: 0.9em; 
        }
        .markdown-content pre { 
            background-color: #f8f9fa; 
            padding: 1em; 
            border-radius: 5px; 
            overflow-x: auto; 
        }
        .markdown-content blockquote { 
            border-left: 4px solid #dee2e6; 
            padding-left: 1em; 
            margin: 1em 0; 
            color: #6c757d; 
        }
        

        /* ÂõæÁâáÊòæÁ§∫Ê†∑Âºè */
        .content-image { 
            max-width: 100%; 
            height: auto; 
            margin: 1em 0; 
            border: 1px solid #dee2e6; 
            border-radius: 5px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        
        /* JSMolÂÆπÂô®Ê†∑Âºè */
        .jsmol-container { 
            margin: 1em 0; 
            text-align: center; 
            border: 1px solid #dee2e6; 
            border-radius: 5px; 
            padding: 10px; 
            background-color: #f8f9fa; 
        }
        
        /* Êñá‰ª∂Ë∑ØÂæÑÈ´ò‰∫Æ */
        .file-path { 
            background-color: #e3f2fd; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-family: monospace; 
            font-size: 0.9em; 
        }
        
        /* Êñá‰ª∂ÈìæÊé•ÂÆπÂô® */
        .file-link-container {
            display: inline-flex;
            align-items: center;
            margin: 2px 0;
            padding: 4px 8px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        /* Êñá‰ª∂ÊòæÁ§∫Âå∫ÂüüÊ†∑Âºè */
        #file-display-area .content-image { 
            max-width: 100%; 
            max-height: 500px;
            height: auto; 
            margin: 1em auto;
            display: block;
            border: 1px solid #dee2e6; 
            border-radius: 5px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        
        #file-display-area .jsmol-container { 
            text-align: center; 
            padding: 20px; 
        }
        
        /* ÊµÅÁ®ãÂõæÊ†∑Âºè */
        .workflow-chart { 
            margin: 1em 0; 
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .workflow-chart .mermaid { 
            text-align: center; 
        }
        
        /* Ê¥ªÂä®ÂéÜÂè≤ÁÆÄÂåñÊ†∑Âºè */
        .history-item-simple {
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .history-item-simple:hover {
            background-color: #f0f0f0;
        }
        
        .history-item-simple.active {
            background-color: #e3f2fd;
            border-left: 4px solid #1976d2;
        }
        
        .activity-badge {
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        /* ÈÄöÁü•ÂºπÁ™óÊ†∑Âºè */
        .notification-popup {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: none;
            border-radius: 8px;
        }
        
        .notification-popup .btn-close {
            padding: 0.25rem;
            font-size: 0.75rem;
        }
    </style>
  </head>
<body>
    <!-- Ëá™Âä®Âà∑Êñ∞ÊèêÁ§∫ -->
    <div class="refresh-indicator" id="refresh-indicator">üîÑ Refreshing...</div>
    
    <div class="container-fluid">
        <div class="row">
            <!-- Â∑¶‰æßËæπÊ†è -->
            <div class="col-md-3 sidebar bg-light p-3">
                <h4 class="mb-3">{{ title }}</h4>
                <div class="mb-3">
                    <a href="/" class="btn btn-outline-primary btn-sm">‚Üê Back to home</a>
                </div>
                
                <!-- ÊúÄËøë‰ªªÂä° -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Recent missions</h6>
                    </div>
                    <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                        {% for recent_task in recent_tasks %}
                        <div class="task-card card mb-2 {% if recent_task.conversation_id == task.conversation_id %}active{% endif %}" 
                             onclick="window.location.href='/task/{{ recent_task.conversation_id }}'">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="small fw-bold">{{ recent_task.task_description[:50] }}{% if recent_task.task_description|length > 50 %}...{% endif %}</div>
                                        <small class="text-muted">{{ recent_task.created_at }}</small>
                                    </div>
                                    <span class="badge status-badge 
                                        {% if recent_task.status == 'completed' %}bg-success
                                        {% elif recent_task.status == 'running' %}bg-primary
                                        {% elif recent_task.status == 'failed' %}bg-danger
                                        {% elif recent_task.status == 'cancelled' %}bg-warning
                                        {% elif recent_task.status == 'queued' %}bg-secondary
                                        {% else %}bg-secondary
                                        {% endif %}">
                                        {% if recent_task.status == 'completed' %}Completed
                                        {% elif recent_task.status == 'running' %}Running
                                        {% elif recent_task.status == 'failed' %}Failed
                                        {% elif recent_task.status == 'cancelled' %}Cancelled
                                        {% elif recent_task.status == 'queued' %}Queued
                                        {% else %}Waiting
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
            <div class="col-md-9 main-content p-3">
                <!-- ‰ªªÂä°Âü∫Êú¨‰ø°ÊÅØ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Task details</h5>
                            <div class="d-flex align-items-center">
                                <span class="badge main-task-status-badge
                                    {% if task.status == 'completed' %}bg-success
                                    {% elif task.status == 'running' %}bg-primary
                                    {% elif task.status == 'failed' %}bg-danger
                                    {% elif task.status == 'cancelled' %}bg-warning text-dark
                                    {% elif task.status == 'queued' %}bg-secondary
                                    {% else %}bg-secondary
                                    {% endif %}">
                                    {% if task.status == 'completed' %}Completed
                                    {% elif task.status == 'running' %}Running
                                    {% elif task.status == 'failed' %}Failed
                                    {% elif task.status == 'cancelled' %}Cancelled
                                    {% elif task.status == 'queued' %}Queued
                                    {% else %}Á≠âÂæÖ‰∏≠
                                    {% endif %}
                                </span>
                                <!-- ÂÅúÊ≠¢‰ªªÂä°ÊåâÈíÆ -->
                                {% if task.status in ['running', 'pending', 'queued'] %}
                                <button class="btn btn-danger btn-sm ms-2" id="stop-task-btn" onclick="stopTask()">
                                    <i class="fas fa-stop"></i> ÂÅúÊ≠¢‰ªªÂä°
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title">{{ task.task_description }}</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <strong>Conversation ID:</strong> {{ task.conversation_id }}<br>
                                    <strong>Creation time:</strong> {{ task.created_at }}<br>
                                    {% if task.started_at %}
                                    <strong>Start time:</strong> {{ task.started_at }}<br>
                                    {% endif %}
                                    {% if task.completed_at %}
                                    <strong>Completion time:</strong> {{ task.completed_at }}<br>
                                    {% endif %}
                                </small>
                            </div>
                            <div class="col-md-6">
                                {% if task.error_message %}
                                <div class="alert alert-danger" role="alert">
                                    <strong>Error message:</strong> {{ task.error_message }}
                                </div>
                                {% endif %}
                                {% if task.result %}
                                <div class="alert alert-success" role="alert">
                                    <strong>Execution result:</strong> Task completed
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Â∑•‰ΩúÊµÅÁ®ãÂõæ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-project-diagram"></i> Workflow
                            <!-- <small class="text-muted ms-2">üí° ÁÇπÂáªÊµÅÁ®ãÂõæ‰∏≠ÁöÑËäÇÁÇπÂèØË∑≥ËΩ¨Âà∞ËØ¶ÊÉÖ</small> -->
                        </h6>
                    </div>
                    <div class="card-body workflow-chart">
                        <div id="workflow-mermaid" class="mermaid">
                            <!-- ÊµÅÁ®ãÂõæÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                        </div>
                        <div class="text-center mt-3" id="workflow-loading" style="display: none;">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="sr-only">ÁîüÊàêÊµÅÁ®ãÂõæ‰∏≠...</span>
                            </div>
                            <small class="text-muted ms-2">Ê≠£Âú®ÁîüÊàêÊµÅÁ®ãÂõæ...</small>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                <span style="color: #1976d2; background: #e3f2fd; padding: 2px 8px; border-radius: 8px; border: 2px solid #1976d2;">Agent</span> Agent &nbsp;
                                <span style="color: #f57c00; background: #fff3e0; padding: 2px 8px; border: 2px solid #f57c00;">Tool</span> Tool &nbsp;
                                <span style="color: #4caf50; background: #e8f5e8; padding: 2px 8px; border-radius: 50%; border: 2px solid #4caf50;">‚óè</span> start/end
                            </small>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Â∑¶‰æßÔºöÂéÜÂè≤ËÆ∞ÂΩïÂàóË°® -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Event history</h6>
                            </div>
                            <div class="card-body p-0" style="max-height: 600px; overflow-y: auto;">
                                <div class="list-group list-group-flush">
                                    {% for log in logs %}
                                    <div class="list-group-item list-group-item-action history-item" 
                                         data-type="{{ log.type }}" 
                                         data-role-name="{{ log.role_name or '' }}"
                                         data-content="{{ log.content|escape }}"
                                         data-timestamp="{{ log.timestamp }}"
                                         data-log-index="{{ loop.index0 }}">
                                        <div class="d-flex w-100 justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <span class="activity-badge 
                                                    {% if log.type == 'system' %}bg-secondary text-white
                                                    {% elif log.type == 'agent_input' %}bg-success text-white
                                                    {% elif log.type == 'agent_output' %}bg-warning text-dark
                                                    {% elif log.type == 'tool_input' %}bg-danger text-white
                                                    {% elif log.type == 'tool_output' %}bg-info text-white
                                                    {% endif %}">
                                                                                        {% if log.type == 'agent_input' %}
                                        <i class="fas fa-robot"></i> {% if log.role_name %}{{ log.role_name }} input{% else %}Agent input{% endif %}
                                    {% elif log.type == 'agent_output' %}
                                        <i class="fas fa-robot"></i> {% if log.role_name %}{{ log.role_name }} output{% else %}Agent output{% endif %}
                                    {% elif log.type == 'tool_input' %}
                                        <i class="fas fa-tools"></i> {% if log.role_name %}{{ log.role_name }} call{% else %}Tool call{% endif %}
                                    {% elif log.type == 'tool_output' %}
                                        <i class="fas fa-tools"></i> {% if log.role_name %}{{ log.role_name }} result{% else %}Tool result{% endif %}
                                    {% else %}
                                        <i class="fas fa-info-circle"></i> {{ log.type_name }}
                                    {% endif %}
                                                </span>
                                            </div>
                                            <small class="text-muted">{{ log.timestamp }}</small>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Âè≥‰æßÔºöËØ¶ÊÉÖÊòæÁ§∫ -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0" id="detail-title">Select an item on the left to view details</h6>
                            </div>
                            <div class="card-body" id="detail-content">
                                <div class="text-center text-muted">
                                    <p>Click on the history record item on the left to view detailed content.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Êñá‰ª∂ÊòæÁ§∫Âå∫Âüü -->
                        <div class="card mt-3" id="file-display-area" style="display: none;">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0" id="file-display-title">File preview</h6>
                                <button class="btn btn-sm btn-outline-secondary" onclick="closeFileDisplay()">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                            <div class="card-body" id="file-display-content">
                                <!-- Âä®ÊÄÅÂÜÖÂÆπÂå∫Âüü -->
                            </div>
                        </div>
                        
                        {% if task.result %}
                        <!-- ÈöêËóèÁöÑÈùôÊÄÅÊï∞ÊçÆ‰º†ÈÄíÂÖÉÁ¥† -->
                        <div data-static-result="{{ task.result|escape }}" style="display: none;"></div>
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">Final result</h6>
                            </div>
                            <div class="card-body">
                                <div class="markdown-content" id="final-result-content">
                                    <!-- ÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÊ∏≤Êüì -->
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <script>
    let currentTaskData = null;
    let refreshInterval = null;
    let lastUpdateTime = 0;
    let isUpdating = false;
    
    // È°µÈù¢Âä†ËΩΩÊó∂Ê∏ÖÁêÜ‰ªª‰ΩïÈÅóÁïôÁöÑÂÆöÊó∂Âô®
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
    
    // Êü•ÊâæÂπ∂Â§ÑÁêÜÊñá‰ª∂Ë∑ØÂæÑ
    function processFilePaths(content) {
        // ‰∏çÂÜçÂõ†‰∏∫ÂåÖÂê´ file-link-container ËÄåÊï¥‰ΩìË∑≥ËøáÔºåÈÅøÂÖçÈÅóÊºèÂêéÁª≠Êñ∞Ë∑ØÂæÑ
        let processedContent = content;
        
        // ‰∏ìÈó®Â§ÑÁêÜÂ∑≤ÁªèÂú®<code>Ê†áÁ≠æÂÜÖÁöÑÊñá‰ª∂Ë∑ØÂæÑ
        function processCodeElements(content) {
            const filePatterns = [
                { ext: 'png', buttonClass: 'primary', iconClass: 'image', iconText: 'View image', showFunction: 'showImageFile' },
                { ext: 'vasp', buttonClass: 'success', iconClass: 'cube', iconText: 'View structure', showFunction: 'showVaspFile' },
                { ext: 'xyz', buttonClass: 'success', iconClass: 'cube', iconText: 'View structure', showFunction: 'showVaspFile' },
                { ext: 'cif', buttonClass: 'success', iconClass: 'cube', iconText: 'View structure', showFunction: 'showVaspFile' }
            ];
            
            let processedContent = content;
            
            // ÂØπÊØèÁßçÊñá‰ª∂Á±ªÂûãËøõË°åÂ§ÑÁêÜ
            filePatterns.forEach(pattern => {
                // ÁÆÄÂçï‰ΩÜÂèØÈù†ÁöÑÊñπÊ≥ïÔºöÊü•ÊâæÁã¨Á´ãÁöÑ<code>Ê†áÁ≠æ
                const codePattern = new RegExp(
                    '<code>(\/[^<]*\\.' + pattern.ext + ')</code>',
                    'gi'
                );
                
                processedContent = processedContent.replace(codePattern, function(match, filePath, offset, string) {
                    // Ê£ÄÊü•Âë®Âõ¥ÁöÑ‰∏ä‰∏ãÊñáÔºåÁ°Æ‰øù‰∏çÊòØÂ∑≤ÁªèÂ§ÑÁêÜËøáÁöÑ
                    const beforeMatch = string.substring(Math.max(0, offset - 100), offset);
                    const afterMatch = string.substring(offset + match.length, offset + match.length + 100);
                    
                    // Â¶ÇÊûúÂâçÈù¢Êúâfile-link-containerÊàñfile-pathÔºåËØ¥ÊòéÂ∑≤ÁªèÂ§ÑÁêÜËøá‰∫Ü
                    if (beforeMatch.includes('file-link-container') || beforeMatch.includes('file-path')) {
                        return match;
                    }
                    
                    // Â¶ÇÊûúÂêéÈù¢Á¥ßË∑üÁùÄbuttonÊ†áÁ≠æÔºåËØ¥ÊòéÂ∑≤ÁªèÂ§ÑÁêÜËøá‰∫Ü
                    if (afterMatch.trim().startsWith('<button')) {
                        return match;
                    }
                    
                    const cleanPath = filePath.trim();
                    
                    // Ê£ÄÊü•Ë∑ØÂæÑÊòØÂê¶ÂêàÁêÜ
                    if (cleanPath.includes('&lt;') || cleanPath.includes('&gt;') || 
                        cleanPath.length < 5 || cleanPath.includes('<') || cleanPath.includes('>')) {
                        return match; // Ë∑≥Ëøá‰∏çÂêàÁêÜÁöÑË∑ØÂæÑ
                    }
                    
                    const encodedPath = encodeURIComponent(cleanPath);
                    const buttonId = pattern.ext + '_btn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    
                    console.log('Â§ÑÁêÜ<code>ÂÜÖÁöÑÊñá‰ª∂Ë∑ØÂæÑ:', cleanPath);
                    
                    return '<span class="file-link-container">' +
                            '<code class="file-path">' + cleanPath + '</code>' +
                            '<button class="btn btn-sm btn-outline-' + pattern.buttonClass + ' ms-2" id="' + buttonId + '" onclick="' + pattern.showFunction + '(decodeURIComponent(\'' + encodedPath + '\'), \'' + buttonId + '\')">' +
                                '<i class="fas fa-' + pattern.iconClass + '"></i> ' + pattern.iconText +
                            '</button>' +
                        '</span>';
                });
            });
            
            return processedContent;
        }
        
        // È¶ñÂÖàÂ§ÑÁêÜ<code>ÂÖÉÁ¥†ÂÜÖÁöÑÊñá‰ª∂Ë∑ØÂæÑ
        processedContent = processCodeElements(processedContent);
        
        // ÂÆâÂÖ®ÁöÑÊñá‰ª∂Ë∑ØÂæÑÂ§ÑÁêÜÂáΩÊï∞
        function processFilePathsSafely(content, fileExtension, buttonClass, iconClass, iconText, showFunction) {
            // ÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂ÂÆπÂô®Êù•Ëß£ÊûêHTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            // Ëé∑ÂèñÊâÄÊúâÊñáÊú¨ËäÇÁÇπÔºà‰∏çÂú®HTMLÊ†áÁ≠æÂÜÖÁöÑÁ∫ØÊñáÊú¨Ôºâ
            const walker = document.createTreeWalker(
                tempDiv,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            const textNodes = [];
            let node;
            while (node = walker.nextNode()) {
                textNodes.push(node);
            }
            
            // Â§ÑÁêÜÊØè‰∏™ÊñáÊú¨ËäÇÁÇπ
            textNodes.forEach(textNode => {
                const text = textNode.textContent;
                const pattern = new RegExp('(/[^\\s\'\"<>]*\\.' + fileExtension + ')\\b', 'gi');
                const matches = [...text.matchAll(pattern)];
                
                if (matches.length > 0) {
                    // Ê£ÄÊü•Áà∂ÂÖÉÁ¥†ÊòØÂê¶Â∑≤ÁªèÊòØcode„ÄÅpreÁ≠âÊ†áÁ≠æ
                    const parent = textNode.parentElement;
                    const isInCodeElement = parent && (
                        parent.tagName.toLowerCase() === 'code' ||
                        parent.tagName.toLowerCase() === 'pre' ||
                        parent.closest('code') ||
                        parent.closest('pre') ||
                        parent.classList.contains('file-path') ||
                        parent.classList.contains('file-link-container')
                    );
                    
                    if (!isInCodeElement) {
                        // ÊõøÊç¢ÊñáÊú¨ËäÇÁÇπÂÜÖÂÆπ
                        let newHTML = text;
                        matches.reverse().forEach(match => { // ÂÄíÂ∫èÂ§ÑÁêÜÈÅøÂÖç‰ΩçÁΩÆÂÅèÁßª
                            const filePath = match[1].trim();
                            const encodedPath = encodeURIComponent(filePath);
                            const buttonId = fileExtension + '_btn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            
                            const buttonHtml = 
                                '<span class="file-link-container">' +
                                    '<code class="file-path">' + filePath + '</code>' +
                                    '<button class="btn btn-sm btn-outline-' + buttonClass + ' ms-2" id="' + buttonId + '" onclick="' + showFunction + '(decodeURIComponent(\'' + encodedPath + '\'), \'' + buttonId + '\')">' +
                                        '<i class="fas fa-' + iconClass + '"></i> ' + iconText +
                                    '</button>' +
                                '</span>';
                            
                            const startIndex = match.index;
                            const endIndex = startIndex + match[0].length;
                            newHTML = newHTML.substring(0, startIndex) + buttonHtml + newHTML.substring(endIndex);
                        });
                        
                        // ÂàõÂª∫Êñ∞ÁöÑHTMLËäÇÁÇπÊù•ÊõøÊç¢ÊñáÊú¨ËäÇÁÇπ
                        if (newHTML !== text) {
                            const wrapper = document.createElement('span');
                            wrapper.innerHTML = newHTML;
                            textNode.parentNode.replaceChild(wrapper, textNode);
                        }
                    } else {
                        console.log('Ë∑≥ËøáÂ∑≤Âú®HTMLÊ†áÁ≠æÂÜÖÁöÑÊñá‰ª∂Ë∑ØÂæÑ:', text.trim());
                    }
                }
            });
            
            return tempDiv.innerHTML;
        }
        
        // Â§ÑÁêÜ.pngÂõæÁâáÊñá‰ª∂
        try {
            processedContent = processFilePathsSafely(processedContent, 'png', 'primary', 'image', 'Show image', 'showImageFile');
        } catch (error) {
            console.warn('Error processing PNG file path:', error);
            // ÂõûÈÄÄÂà∞ÁÆÄÂçïÁöÑÊ≠£ÂàôÂ§ÑÁêÜÔºå‰ΩÜÂ¢ûÂä†ÂÆâÂÖ®Ê£ÄÊü•
            const imagePattern = /(?<!<[^>]*?)(\/[^\s'"<>]*\.png)\b(?![^<]*?>)/gi;
            processedContent = processedContent.replace(imagePattern, function(match, filePath, offset, string) {
                // Ê£ÄÊü•ÊòØÂê¶Âú®HTMLÊ†áÁ≠æÂÜÖ
                const beforeMatch = string.substring(0, offset);
                const afterMatch = string.substring(offset + match.length);
                const lastOpenTag = beforeMatch.lastIndexOf('<');
                const lastCloseTag = beforeMatch.lastIndexOf('>');
                const nextCloseTag = afterMatch.indexOf('>');
                
                // Â¶ÇÊûúÂú®HTMLÊ†áÁ≠æÂÜÖÂàôË∑≥Ëøá
                if (lastOpenTag > lastCloseTag && nextCloseTag !== -1) {
                    return match;
                }
                
                const cleanPath = filePath.trim();
                const encodedPath = encodeURIComponent(cleanPath);
                const buttonId = 'img_btn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                return '<span class="file-link-container">' +
                        '<code class="file-path">' + cleanPath + '</code>' +
                        '<button class="btn btn-sm btn-outline-primary ms-2" id="' + buttonId + '" onclick="showImageFile(decodeURIComponent(\'' + encodedPath + '\'), \'' + buttonId + '\')">' +
                            '<i class="fas fa-image"></i> View image' +
                        '</button>' +
                    '</span>';
            });
        }
        
        // Â§ÑÁêÜ.vaspÊô∂‰ΩìÁªìÊûÑÊñá‰ª∂
        try {
            processedContent = processFilePathsSafely(processedContent, 'vasp', 'success', 'cube', 'Show structure', 'showVaspFile');
        } catch (error) {
            console.warn('Error processing VASP file path:', error);
            // ÂõûÈÄÄÂà∞ÁÆÄÂçïÁöÑÊ≠£ÂàôÂ§ÑÁêÜÔºå‰ΩÜÂ¢ûÂä†ÂÆâÂÖ®Ê£ÄÊü•
            const vaspPattern = /(?<!<[^>]*?)(\/[^\s'"<>]*\.vasp)\b(?![^<]*?>)/gi;
            processedContent = processedContent.replace(vaspPattern, function(match, filePath, offset, string) {
                // Ê£ÄÊü•ÊòØÂê¶Âú®HTMLÊ†áÁ≠æÂÜÖ
                const beforeMatch = string.substring(0, offset);
                const afterMatch = string.substring(offset + match.length);
                const lastOpenTag = beforeMatch.lastIndexOf('<');
                const lastCloseTag = beforeMatch.lastIndexOf('>');
                const nextCloseTag = afterMatch.indexOf('>');
                
                // Â¶ÇÊûúÂú®HTMLÊ†áÁ≠æÂÜÖÂàôË∑≥Ëøá
                if (lastOpenTag > lastCloseTag && nextCloseTag !== -1) {
                    return match;
                }
                
                const cleanPath = filePath.trim();
                const encodedPath = encodeURIComponent(cleanPath);
                const buttonId = 'vasp_btn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                return '<span class="file-link-container">' +
                        '<code class="file-path">' + cleanPath + '</code>' +
                        '<button class="btn btn-sm btn-outline-success ms-2" id="' + buttonId + '" onclick="showVaspFile(decodeURIComponent(\'' + encodedPath + '\'), \'' + buttonId + '\')">' +
                            '<i class="fas fa-cube"></i> View structure' +
                        '</button>' +
                    '</span>';
            });
        }
        
        // Â§ÑÁêÜ.xyzÊô∂‰ΩìÁªìÊûÑÊñá‰ª∂
        try {
            processedContent = processFilePathsSafely(processedContent, 'xyz', 'success', 'cube', 'Êü•ÁúãÁªìÊûÑ', 'showVaspFile');
        } catch (error) {
            console.warn('Â§ÑÁêÜXYZÊñá‰ª∂Ë∑ØÂæÑÊó∂Âá∫Èîô:', error);
            // ÂõûÈÄÄÂà∞ÁÆÄÂçïÁöÑÊ≠£ÂàôÂ§ÑÁêÜ
            const xyzPattern = /(?<!<[^>]*?)(\/[^\s'"<>]*\.xyz)\b(?![^<]*?>)/gi;
            processedContent = processedContent.replace(xyzPattern, function(match, filePath, offset, string) {
                const beforeMatch = string.substring(0, offset);
                const afterMatch = string.substring(offset + match.length);
                const lastOpenTag = beforeMatch.lastIndexOf('<');
                const lastCloseTag = beforeMatch.lastIndexOf('>');
                const nextCloseTag = afterMatch.indexOf('>');
                
                if (lastOpenTag > lastCloseTag && nextCloseTag !== -1) {
                    return match;
                }
                
                const cleanPath = filePath.trim();
                const encodedPath = encodeURIComponent(cleanPath);
                const buttonId = 'xyz_btn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                return '<span class="file-link-container">' +
                        '<code class="file-path">' + cleanPath + '</code>' +
                        '<button class="btn btn-sm btn-outline-success ms-2" id="' + buttonId + '" onclick="showVaspFile(decodeURIComponent(\'' + encodedPath + '\'), \'' + buttonId + '\')">' +
                            '<i class="fas fa-cube"></i> View structure' +
                        '</button>' +
                    '</span>';
            });
        }
        
        // Â§ÑÁêÜ.cifÊô∂‰ΩìÁªìÊûÑÊñá‰ª∂
        try {
            processedContent = processFilePathsSafely(processedContent, 'cif', 'success', 'cube', 'Êü•ÁúãÁªìÊûÑ', 'showVaspFile');
        } catch (error) {
            console.warn('Â§ÑÁêÜCIFÊñá‰ª∂Ë∑ØÂæÑÊó∂Âá∫Èîô:', error);
            // ÂõûÈÄÄÂà∞ÁÆÄÂçïÁöÑÊ≠£ÂàôÂ§ÑÁêÜ
            const cifPattern = /(?<!<[^>]*?)(\/[^\s'"<>]*\.cif)\b(?![^<]*?>)/gi;
            processedContent = processedContent.replace(cifPattern, function(match, filePath, offset, string) {
                const beforeMatch = string.substring(0, offset);
                const afterMatch = string.substring(offset + match.length);
                const lastOpenTag = beforeMatch.lastIndexOf('<');
                const lastCloseTag = beforeMatch.lastIndexOf('>');
                const nextCloseTag = afterMatch.indexOf('>');
                
                if (lastOpenTag > lastCloseTag && nextCloseTag !== -1) {
                    return match;
                }
                
                const cleanPath = filePath.trim();
                const encodedPath = encodeURIComponent(cleanPath);
                const buttonId = 'cif_btn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                return '<span class="file-link-container">' +
                        '<code class="file-path">' + cleanPath + '</code>' +
                        '<button class="btn btn-sm btn-outline-success ms-2" id="' + buttonId + '" onclick="showVaspFile(decodeURIComponent(\'' + encodedPath + '\'), \'' + buttonId + '\')">' +
                            '<i class="fas fa-cube"></i> View structure' +
                        '</button>' +
                    '</span>';
            });
        }
        
        return processedContent;
    }
    
    // Ê∏≤ÊüìÂÜÖÂÆπ
    function renderContent(content, type) {
        if (type === 'tool_input' || type === 'tool_output') {
            const processedContent = processFilePaths(content);
            return '<pre class="mb-0">' + processedContent + '</pre>';
        } else if (type === 'agent_input' || type === 'agent_output') {
            try {
                const rendered = marked.parse(content);
                const processedContent = processFilePaths(rendered);
                return '<div class="markdown-content">' + processedContent + '</div>';
            } catch (e) {
                const processedContent = processFilePaths(content);
                return '<pre class="mb-0">' + processedContent + '</pre>';
            }
        } else {
            return '<pre class="mb-0">' + content + '</pre>';
        }
    }
    
    // ÊòæÁ§∫Âà∑Êñ∞ÊåáÁ§∫Âô®
    function showRefreshIndicator() {
        const indicator = document.getElementById('refresh-indicator');
        if (indicator) {
            indicator.classList.add('active');
            setTimeout(() => indicator.classList.remove('active'), 1000);
        }
    }
    
    // Êõ¥Êñ∞‰ªªÂä°Áä∂ÊÄÅÂæΩÁ´†ÔºàÂè™Êõ¥Êñ∞‰∏ª‰ªªÂä°Áä∂ÊÄÅÔºå‰∏çÂΩ±Âìç‰æßËæπÊ†èÔºâ
    function updateTaskStatus(status) {
        // Âè™Êõ¥Êñ∞‰∏ª‰ªªÂä°ÁöÑÁä∂ÊÄÅÊ†áÁ≠æÔºåÈÅøÂÖçÂΩ±Âìç‰æßËæπÊ†èÁöÑÂÖ∂‰ªñ‰ªªÂä°
        const mainTaskBadge = document.querySelector('.main-task-status-badge');
        if (!mainTaskBadge) return;
        
        // Ê£ÄÊü•ÂΩìÂâçÁä∂ÊÄÅÊòØÂê¶Â∑≤ÁªèÊ≠£Á°ÆÔºåÈÅøÂÖç‰∏çÂøÖË¶ÅÁöÑÊõ¥Êñ∞
        let currentStatus = '';
        if (mainTaskBadge.textContent.trim() === 'Completed') currentStatus = 'completed';
        else if (mainTaskBadge.textContent.trim() === 'Running') currentStatus = 'running';
        else if (mainTaskBadge.textContent.trim() === 'Failed') currentStatus = 'failed';
        else if (mainTaskBadge.textContent.trim() === 'Cancelled') currentStatus = 'cancelled';
        else if (mainTaskBadge.textContent.trim() === 'Queued') currentStatus = 'queued';
        else currentStatus = 'pending';
        
        // Âè™ÊúâÂΩìÁä∂ÊÄÅÁúüÁöÑÂèëÁîüÂèòÂåñÊó∂ÊâçÊõ¥Êñ∞
        if (currentStatus !== status) {
            console.log('Main task status updated: ' + currentStatus + ' ‚Üí ' + status);
            mainTaskBadge.className = 'badge main-task-status-badge';
            if (status === 'completed') {
                mainTaskBadge.className += ' bg-success';
                mainTaskBadge.textContent = 'Completed';
            } else if (status === 'running') {
                mainTaskBadge.className += ' bg-primary';
                mainTaskBadge.textContent = 'Running';
            } else if (status === 'failed') {
                mainTaskBadge.className += ' bg-danger';
                mainTaskBadge.textContent = 'Failed';
            } else if (status === 'cancelled') {
                mainTaskBadge.className += ' bg-warning text-dark';
                mainTaskBadge.textContent = 'Cancelled';
            } else if (status === 'queued') {
                mainTaskBadge.className += ' bg-secondary';
                mainTaskBadge.textContent = 'Queued';
            } else {
                mainTaskBadge.className += ' bg-secondary';
                mainTaskBadge.textContent = 'Waiting';
            }
            
            // Ê†πÊçÆ‰ªªÂä°Áä∂ÊÄÅÊòæÁ§∫ÊàñÈöêËóèÂÅúÊ≠¢ÊåâÈíÆ
            updateStopButton(status);
        }
    }
    
    // Êõ¥Êñ∞ÂÅúÊ≠¢ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
    function updateStopButton(status) {
        const stopBtn = document.getElementById('stop-task-btn');
        if (stopBtn) {
            if (status === 'running' || status === 'pending' || status === 'queued') {
                stopBtn.style.display = 'inline-block';
            } else {
                stopBtn.style.display = 'none';
            }
        }
    }
    
    // ÂÅúÊ≠¢‰ªªÂä°ÂáΩÊï∞
    async function stopTask() {
        const stopBtn = document.getElementById('stop-task-btn');
        if (!stopBtn) return;
        
        // Á°ÆËÆ§ÂØπËØùÊ°Ü
        if (!confirm('Á°ÆÂÆöË¶ÅÂÅúÊ≠¢ÂΩìÂâç‰ªªÂä°ÂêóÔºü\n\nÂÅúÊ≠¢‰ªªÂä°ÂêéÂ∞ÜÊó†Ê≥ïÊÅ¢Â§çÔºåÊ≠£Âú®ËøõË°åÁöÑËÆ°ÁÆó‰πü‰ºöË¢´ÂèñÊ∂à„ÄÇ')) {
            return;
        }
        
        try {
            // Á¶ÅÁî®ÊåâÈíÆÂπ∂ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            stopBtn.disabled = true;
            const originalContent = stopBtn.innerHTML;
            stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÂÅúÊ≠¢‰∏≠...';
            
            const taskId = getCurrentTaskId();
            const response = await fetch('/api/task/' + taskId + '/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                // ÂÅúÊ≠¢ÊàêÂäü
                console.log('‰ªªÂä°ÂÅúÊ≠¢ÊàêÂäü:', result);
                
                // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                showNotification('‰ªªÂä°Â∑≤ÂÅúÊ≠¢', 'success');
                
                // Êõ¥Êñ∞‰ªªÂä°Áä∂ÊÄÅ
                updateTaskStatus('cancelled');
                
                // ÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
                
                // Ëé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆ‰ª•Êõ¥Êñ∞ÁïåÈù¢
                setTimeout(() => {
                    fetchLatestData(true);
                }, 1000);
                
            } else {
                // ÂÅúÊ≠¢Â§±Ë¥•
                console.error('ÂÅúÊ≠¢‰ªªÂä°Â§±Ë¥•:', result);
                showNotification(result.error || 'ÂÅúÊ≠¢‰ªªÂä°Â§±Ë¥•', 'error');
                
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                stopBtn.disabled = false;
                stopBtn.innerHTML = originalContent;
            }
            
        } catch (error) {
            console.error('ÂÅúÊ≠¢‰ªªÂä°Êó∂ÂèëÁîüÈîôËØØ:', error);
            showNotification('ÂÅúÊ≠¢‰ªªÂä°Êó∂ÂèëÁîüÈîôËØØ: ' + error.message, 'error');
            
            // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
            stopBtn.disabled = false;
            stopBtn.innerHTML = originalContent;
        }
    }
    
    // ÊòæÁ§∫ÈÄöÁü•Ê∂àÊÅØ
    function showNotification(message, type = 'info') {
        // ÂàõÂª∫ÈÄöÁü•ÂÖÉÁ¥†
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} notification-popup`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            opacity: 0;
            transition: opacity 0.3s ease;
        `;
        
        notification.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                <span>${message}</span>
                <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // ÊòæÁ§∫Âä®Áîª
        setTimeout(() => {
            notification.style.opacity = '1';
        }, 100);
        
        // Ëá™Âä®ÈöêËóè
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 5000);
    }
    
    // ÊèêÂèñÂ∑•ÂÖ∑ÂêçÁß∞ÁöÑËæÖÂä©ÂáΩÊï∞
    function extractToolName(content) {
        try {
            const data = JSON.parse(content);
            if (data.tool_name) return data.tool_name;
            if (data.name) return data.name;
            if (data.function && data.function.name) return data.function.name;
            if (data.tool && data.tool.name) return data.tool.name;
            if (data.method) return data.method;
            if (data.action) return data.action;
            
            // Êü•ÊâæÂèØËÉΩÁöÑÂêçÁß∞Â≠óÊÆµ
            const keys = Object.keys(data);
            const possibleNames = keys.filter(key => 
                key.toLowerCase().includes('name') || 
                key.toLowerCase().includes('tool') ||
                key.toLowerCase().includes('method') ||
                key.toLowerCase().includes('action')
            );
            if (possibleNames.length > 0) {
                const value = data[possibleNames[0]];
                if (typeof value === 'string' && value.trim() !== '') {
                    return value.trim();
                }
            }
        } catch (e) {}
        return null;
    }
    
    // ÊèêÂèñAgentÂêçÁß∞ÁöÑËæÖÂä©ÂáΩÊï∞
    function extractAgentName(content) {
        try {
            const data = JSON.parse(content);
            if (data.agent_name) return data.agent_name;
            if (data.name) return data.name;
            if (data.role) return data.role;
            if (data.agent) return data.agent;
        } catch (e) {}
        return null;
    }

    // Êõ¥Êñ∞ÂéÜÂè≤ËÆ∞ÂΩïÂàóË°®
    function updateHistoryList(logs) {
        const historyContainer = document.querySelector('.list-group');
        if (!historyContainer) return;
        
        // Èò≤Êäñ‰øùÊä§ÔºöÈÅøÂÖçÁü≠Êó∂Èó¥ÂÜÖÈáçÂ§çÊõ¥Êñ∞
        const now = Date.now();
        if (isUpdating || (now - lastUpdateTime < 500)) {
            console.log('‚è≠Ô∏è Skip history record update');
            return;
        }
        
        isUpdating = true;
        lastUpdateTime = now;
        
        console.log('üîÑ Start updating history record list, log number:', logs.length);
        
        try {
            // ‰øùÂ≠òÂΩìÂâçÈÄâ‰∏≠ÁöÑÈ°πÁõÆ
            const activeItem = historyContainer.querySelector('.history-item.active');
            const activeTimestamp = activeItem ? activeItem.dataset.timestamp : null;
            
            // ÊÄªÊòØÂÆåÂÖ®ÈáçÂª∫ÂàóË°®‰ª•ÈÅøÂÖçÈáçÂ§çÊòæÁ§∫ÈóÆÈ¢ò
            console.log('üìù Completely rebuild history record list');
            historyContainer.innerHTML = '';
            
            // ÈáçÊñ∞ÂàõÂª∫ÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩïÈ°π
            logs.forEach((log, index) => {
                const historyItem = createHistoryItem(log, index);
                historyContainer.appendChild(historyItem);
            });
            
            // ÊÅ¢Â§çÈÄâ‰∏≠Áä∂ÊÄÅ
            if (activeTimestamp) {
                const newActiveItem = historyContainer.querySelector(`[data-timestamp="${activeTimestamp}"]`);
                if (newActiveItem) {
                    newActiveItem.classList.add('active');
                }
            }
            
            console.log('‚úÖ History record list updated, total', logs.length, 'items');
        } finally {
            // Á°Æ‰øùÂú®‰ªª‰ΩïÊÉÖÂÜµ‰∏ãÈÉΩ‰ºöÈáçÁΩÆÊõ¥Êñ∞Áä∂ÊÄÅ
            setTimeout(() => {
                isUpdating = false;
            }, 100);
        }
    }
    
    // ÂàõÂª∫ÂéÜÂè≤ËÆ∞ÂΩïÈ°πÁõÆ
    function createHistoryItem(log, index) {
        const historyItem = document.createElement('div');
        historyItem.className = 'list-group-item list-group-item-action history-item';
        historyItem.dataset.type = log.type;
        historyItem.dataset.roleName = log.role_name || '';
        historyItem.dataset.content = log.content;
        historyItem.dataset.timestamp = log.timestamp;
        if (typeof index === 'number') {
            historyItem.dataset.logIndex = index;
        }
        
        // Ë∞ÉËØï‰ø°ÊÅØÔºàÂ∑≤ÁßªÈô§‰ª•ÂáèÂ∞ëÊéßÂà∂Âè∞Âô™Èü≥Ôºâ
        
        let badgeClass = 'bg-secondary text-white';
        let badgeText = log.type_name;
        let badgeIcon = 'fas fa-info-circle';
        let specificName = '';
        
        if (log.type === 'system') {
            badgeClass = 'bg-secondary text-white';
            badgeIcon = 'fas fa-info-circle';
            badgeText = log.type_name;
        } else if (log.type === 'agent_input') {
            badgeClass = 'bg-success text-white';
            badgeIcon = 'fas fa-robot';
            specificName = log.role_name;
            badgeText = specificName ? specificName + ' input' : 'Agent input';
        } else if (log.type === 'agent_output') {
            badgeClass = 'bg-warning text-dark';
            badgeIcon = 'fas fa-robot';
            specificName = log.role_name;
            badgeText = specificName ? specificName + ' output' : 'Agent output';
        } else if (log.type === 'tool_input') {
            badgeClass = 'bg-danger text-white';
            badgeIcon = 'fas fa-tools';
            specificName = log.role_name;
            badgeText = specificName ? specificName + ' call' : 'Tool call';
        } else if (log.type === 'tool_output') {
            badgeClass = 'bg-info text-white';
            badgeIcon = 'fas fa-tools';
            specificName = log.role_name;
            badgeText = specificName ? specificName + ' result' : 'Tool result';
        }
        
        historyItem.innerHTML = 
            '<div class="d-flex w-100 justify-content-between align-items-center">' +
                '<div class="d-flex align-items-center">' +
                    '<span class="activity-badge ' + badgeClass + '">' +
                        '<i class="' + badgeIcon + '"></i> ' + badgeText +
                    '</span>' +
                '</div>' +
                '<small class="text-muted">' + log.timestamp + '</small>' +
            '</div>';
        
        return historyItem;
    }
    
    // ÁîüÊàêÂ∑•‰ΩúÊµÅÁ®ãÂõæ
    async function generateWorkflowChart(logs) {
        const workflowContainer = document.getElementById('workflow-mermaid');
        const loadingIndicator = document.getElementById('workflow-loading');
        
        if (!workflowContainer || !logs || logs.length === 0) {
            return;
        }
        
        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        loadingIndicator.style.display = 'block';
        workflowContainer.innerHTML = '';
        
        try {
            // ÂàÜÊûêÊó•ÂøóÔºåÊèêÂèñAgentÂíåToolÂ∫èÂàó
            const activities = [];
            let currentAgent = null;
            let agentTools = [];
            let agentIndex = 0;
            let toolIndex = 0;
            
            logs.forEach((log, index) => {
                // ËøáÊª§ÊéâmanagerÁõ∏ÂÖ≥ÁöÑÊó•ÂøóÔºåËøô‰∫õÈÄöÂ∏∏ÊòØÊ°ÜÊû∂ÂÜÖÈÉ®ÁöÑÁÆ°ÁêÜÂô®ËäÇÁÇπ
                const isManagerRelated = log.role_name && log.role_name.toLowerCase().includes('manager');
                
                if (isManagerRelated) {
                    return; // Ë∑≥ËøámanagerÁõ∏ÂÖ≥ÁöÑÊó•Âøó
                }
                
                if (log.type === 'agent_input') {
                    // Â¶ÇÊûú‰πãÂâçÊúâAgentÔºåÂÖà‰øùÂ≠òÂÆÉ
                    if (currentAgent) {
                        // Êü•ÊâæÂØπÂ∫îÁöÑagent_output
                        const outputLog = logs.find((l, idx) => 
                            idx > currentAgent.logIndex && 
                            l.type === 'agent_output' && 
                            l.role_name === currentAgent.originalName
                        );
                        
                        activities.push({
                            type: 'agent',
                            id: 'agent' + (agentIndex++),
                            name: currentAgent.name,
                            tools: [...agentTools],
                            timestamp: currentAgent.timestamp,
                            logIndex: currentAgent.logIndex,
                            outputTimestamp: outputLog ? outputLog.timestamp : currentAgent.timestamp,
                            outputLogIndex: outputLog ? logs.indexOf(outputLog) : currentAgent.logIndex
                        });
                    }
                    
                    // Áõ¥Êé•‰ΩøÁî®role_nameÂ≠óÊÆµ
                    let agentName = log.role_name || 'Agent-' + (agentIndex + 1);
                    const originalName = log.role_name;
                    
                    // Ë∞ÉËØï‰ø°ÊÅØÔºàÂ∑≤ÁßªÈô§Ôºâ
                    
                    // ÈôêÂà∂ÈïøÂ∫¶‰ª•ÈÅøÂÖçÊµÅÁ®ãÂõæËøáÂÆΩ
                    if (agentName.length > 25) {
                        agentName = agentName.substring(0, 22) + '...';
                    }
                    
                    // ÂºÄÂßãÊñ∞ÁöÑAgentÊ¥ªÂä®
                    currentAgent = {
                        name: agentName,
                        originalName: originalName,
                        timestamp: log.timestamp,
                        logIndex: index
                    };
                    agentTools = [];
                    
                } else if (log.type === 'tool_input' && currentAgent) {
                    // Áõ¥Êé•‰ΩøÁî®role_nameÂ≠óÊÆµ
                    let toolName = log.role_name || 'Tool-' + (toolIndex + 1);
                    
                    // Ë∞ÉËØï‰ø°ÊÅØÔºàÂ∑≤ÁßªÈô§Ôºâ
                    
                    // ÈôêÂà∂ÈïøÂ∫¶‰ª•ÈÅøÂÖçÊµÅÁ®ãÂõæËøáÂÆΩ
                    if (toolName.length > 20) {
                        toolName = toolName.substring(0, 17) + '...';
                    }
                    
                    agentTools.push({
                        id: 'tool' + (toolIndex++),
                        name: toolName,
                        timestamp: log.timestamp,
                        logIndex: index
                    });
                }
            });
            
            // ‰øùÂ≠òÊúÄÂêé‰∏Ä‰∏™Agent
            if (currentAgent) {
                // Êü•ÊâæÂØπÂ∫îÁöÑagent_output
                const outputLog = logs.find((l, idx) => 
                    idx > currentAgent.logIndex && 
                    l.type === 'agent_output' && 
                    l.role_name === currentAgent.originalName
                );
                
                activities.push({
                    type: 'agent',
                    id: 'agent' + (agentIndex++),
                    name: currentAgent.name,
                    tools: [...agentTools],
                    timestamp: currentAgent.timestamp,
                    logIndex: currentAgent.logIndex,
                    outputTimestamp: outputLog ? outputLog.timestamp : currentAgent.timestamp,
                    outputLogIndex: outputLog ? logs.indexOf(outputLog) : currentAgent.logIndex
                });
            }
            
            // ÂàõÂª∫Â∑•ÂÖ∑ÂàóË°®ÔºàÂú®Â§ñÈÉ®‰ΩúÁî®ÂüüÔºâ
            const allTools = [];
            activities.forEach(activity => {
                activity.tools.forEach(tool => {
                    allTools.push({
                        agentId: activity.id,
                        agentName: activity.name,
                        ...tool
                    });
                });
            });
            
            // ÁîüÊàêMermaidÊµÅÁ®ãÂõæ‰ª£Á†Å - Êîπ‰∏∫Ê∞¥Âπ≥Â∏ÉÂ±Ä
            let mermaidCode = 'graph LR\n';
            
            if (activities.length === 0) {
                mermaidCode += '    Start([Start]) --> End([End])\n';
            } else {
                // Ê∑ªÂä†ÂºÄÂßãËäÇÁÇπ
                mermaidCode += '    Start([Start])\n';
                
                // ÂàõÂª∫AgentËäÇÁÇπ - ‰ΩøÁî®ÂúÜËßíÈïøÊñπÂΩ¢
                activities.forEach((activity, index) => {
                    // Ê∏ÖÁêÜAgentÂêçÁß∞ÔºåÁ°Æ‰øù‰ΩøÁî®ÂÖ∑‰ΩìÂêçÁß∞
                    let safeName = activity.name.replace(/[^\w\s\-\.\u4e00-\u9fff]/g, '').trim();
                    if (!safeName || safeName.match(/^Agent[-\s]*\d*$/i)) {
                        // Â¶ÇÊûúÊòØÈªòËÆ§ÂêçÁß∞ÊàñÁ©∫ÂêçÁß∞Ôºå‰ΩøÁî®Êõ¥ÂÖ∑‰ΩìÁöÑÂêçÁß∞
                        safeName = 'Agent' + (index + 1);
                    }
                    // ÁßªÈô§Â∏∏ËßÅÁöÑÂâçÁºÄ
                    safeName = safeName.replace(/^(Agent|agent|‰ª£ÁêÜ)[-\s]*/i, '');
                    if (!safeName) {
                        safeName = 'Agent' + (index + 1);
                    }
                    if (safeName.length > 25) {
                        safeName = safeName.substring(0, 22) + '...';
                    }
                    
                    // ‰ΩøÁî®ÂúÜËßíÈïøÊñπÂΩ¢ÊòæÁ§∫Agent
                    mermaidCode += '    ' + activity.id + '(' + safeName + ')\n';
                });
                
                // ËøûÊé•AgentËäÇÁÇπ
                for (let i = 0; i < activities.length - 1; i++) {
                    mermaidCode += '    ' + activities[i].id + ' --> ' + activities[i + 1].id + '\n';
                }
                
                // ÂàõÂª∫Â∑•ÂÖ∑ËäÇÁÇπ - ‰ΩøÁî®ÊñπËßíÈïøÊñπÂΩ¢
                if (allTools.length > 0) {
                    allTools.forEach((tool, toolIndex) => {
                        // Ê∏ÖÁêÜÂ∑•ÂÖ∑ÂêçÁß∞ÔºåÁ°Æ‰øù‰ΩøÁî®ÂÖ∑‰ΩìÂêçÁß∞
                        let safeToolName = tool.name.replace(/[^\w\s\-\.\u4e00-\u9fff]/g, '').trim();
                        if (!safeToolName || safeToolName.match(/^Tool[-\s]*\d*$/i)) {
                            // Â¶ÇÊûúÊòØÈªòËÆ§ÂêçÁß∞ÊàñÁ©∫ÂêçÁß∞Ôºå‰ΩøÁî®Êõ¥ÊèèËø∞ÊÄßÁöÑÂêçÁß∞
                            safeToolName = 'Tool' + (toolIndex + 1);
                        }
                        // ÁßªÈô§Â∏∏ËßÅÁöÑÂâçÁºÄ
                        safeToolName = safeToolName.replace(/^(Tool|tool|Tool)[-\s]*/i, '');
                        if (!safeToolName) {
                            safeToolName = 'Tool' + (toolIndex + 1);
                        }
                        if (safeToolName.length > 20) {
                            safeToolName = safeToolName.substring(0, 17) + '...';
                        }
                        
                        // ‰ΩøÁî®ÊñπËßíÈïøÊñπÂΩ¢ÊòæÁ§∫Tool
                        mermaidCode += '    ' + tool.id + '[' + safeToolName + ']\n';
                    });
                    
                    // ËøûÊé•AgentÂíåÂ∑•ÂÖ∑ - ‰ΩøÁî®ËôöÁ∫ø
                    allTools.forEach(tool => {
                        mermaidCode += '    ' + tool.agentId + ' -.-> ' + tool.id + '\n';
                        mermaidCode += '    ' + tool.id + ' -.-> ' + tool.agentId + '\n';
                    });
                }
                
                // ËøûÊé•ÂºÄÂßãÂíåÁªìÊùüËäÇÁÇπ
                if (activities.length > 0) {
                    mermaidCode += '    Start --> ' + activities[0].id + '\n';
                    mermaidCode += '    ' + activities[activities.length-1].id + ' --> End([End])\n';
                }
                
                // Ê≥®ÊÑèÔºöÁÇπÂáª‰∫ã‰ª∂Áé∞Âú®ÈÄöËøáJavaScriptÊâãÂä®ÁªëÂÆöÔºå‰∏çÂú®Mermaid‰ª£Á†Å‰∏≠Â£∞Êòé
            }
            
            // Ê∑ªÂä†Ê†∑Âºè
            mermaidCode += '\n';
            mermaidCode += '    classDef agentNode fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#000,cursor:pointer\n';
            mermaidCode += '    classDef toolNode fill:#fff3e0,stroke:#f57c00,stroke-width:3px,color:#000,cursor:pointer\n';
            mermaidCode += '    classDef startEndNode fill:#e8f5e8,stroke:#4caf50,stroke-width:3px,color:#000\n';
            
            activities.forEach(activity => {
                mermaidCode += '    class ' + activity.id + ' agentNode\n';
            });
            allTools.forEach(tool => {
                mermaidCode += '    class ' + tool.id + ' toolNode\n';
            });
            mermaidCode += '    class Start,End startEndNode\n';
            
            console.log('ÁîüÊàêÁöÑMermaid‰ª£Á†Å:', mermaidCode);
            
            // Ê∏≤ÊüìÊµÅÁ®ãÂõæ
            if (typeof mermaid !== 'undefined') {
                // Ê∏ÖÈô§‰πãÂâçÁöÑÂÜÖÂÆπ
                workflowContainer.innerHTML = '';
                
                // ‰ΩøÁî®Áé∞‰ª£ÁöÑMermaid API
                try {
                    const renderResult = await mermaid.render('workflow-graph-' + Date.now(), mermaidCode);
                    workflowContainer.innerHTML = renderResult.svg;
                    
                    // ÊâãÂä®ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂Âà∞SVGÂÖÉÁ¥†Ôºà‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÔºåÂÖºÂÆπMermaidÁîüÊàêÁöÑIDÂâçÁºÄÔºâ
                    const svgElement = workflowContainer.querySelector('svg');
                    if (svgElement) {
                        svgElement.style.cursor = 'pointer';
                        svgElement.addEventListener('click', function(event) {
                            const idChain = [];
                            let node = event.target;
                            let matched = false;

                            while (node && node !== svgElement) {
                                if (node.tagName && node.tagName.toLowerCase() === 'g' && node.id) {
                                    idChain.push(node.id);
                                    const rawId = node.id.replace(/^flowchart-/, '');
                                    // ÂéªÊéâÂ∏∏ËßÅÁöÑÂâçÁºÄÔºåÂ¶Ç label- / node-
                                    const candidates = [rawId, rawId.replace(/^(label-|node-)/, '')];

                                    let activityNode = null;
                                    let toolNode = null;

                                    for (const rid of candidates) {
                                        activityNode = activities.find(a => rid === a.id || rid.startsWith(a.id + '-') || rid.endsWith('-' + a.id) || rid.includes('-' + a.id + '-'));
                                        if (activityNode) break;
                                    }
                                    if (activityNode) {
                                        jumpToActivityDetails(activityNode, 'agent', logs);
                                        matched = true;
                                        break;
                                    }

                                    for (const rid of candidates) {
                                        toolNode = allTools.find(t => rid === t.id || rid.startsWith(t.id + '-') || rid.endsWith('-' + t.id) || rid.includes('-' + t.id + '-'));
                                        if (toolNode) break;
                                    }
                                    if (toolNode) {
                                        jumpToActivityDetails(toolNode, 'tool', logs);
                                        matched = true;
                                        break;
                                    }
                                }
                                node = node.parentElement;
                            }

                            if (!matched) {
                                console.warn('Workflow click: no matching node found', {
                                    clickedTag: event.target.tagName,
                                    idChain: idChain,
                                    knownAgentIds: activities.map(a => a.id),
                                    knownToolIds: allTools.map(t => t.id)
                                });
                            }
                        });
                    }
                    
                    console.log('MermaidÊµÅÁ®ãÂõæÊ∏≤ÊüìÊàêÂäü');
                } catch (error) {
                    console.error('MermaidÊ∏≤ÊüìÂ§±Ë¥•:', error);
                    // ÂõûÈÄÄÂà∞ÊóßÁöÑÊ∏≤ÊüìÊñπÊ≥ï
                    try {
                        const mermaidElement = document.createElement('div');
                        mermaidElement.className = 'mermaid';
                        mermaidElement.textContent = mermaidCode;
                        workflowContainer.appendChild(mermaidElement);
                        mermaid.init(undefined, mermaidElement);
                        console.log('‰ΩøÁî®ÂõûÈÄÄÊñπÊ≥ïÊ∏≤ÊüìÊµÅÁ®ãÂõæ');
                        // ÂõûÈÄÄÊ∏≤ÊüìÂêéÂêåÊ†∑ÁªëÂÆö‰∫ã‰ª∂Ôºà‰∫ã‰ª∂ÂßîÊâòÔºâ
                        const svgElement = workflowContainer.querySelector('svg');
                        if (svgElement) {
                            svgElement.style.cursor = 'pointer';
                            svgElement.addEventListener('click', function(event) {
                                const idChain = [];
                                let node = event.target;
                                let matched = false;

                                while (node && node !== svgElement) {
                                    if (node.tagName && node.tagName.toLowerCase() === 'g' && node.id) {
                                        idChain.push(node.id);
                                        const rawId = node.id.replace(/^flowchart-/, '');
                                        const candidates = [rawId, rawId.replace(/^(label-|node-)/, '')];

                                        let activityNode = null;
                                        let toolNode = null;

                                        for (const rid of candidates) {
                                            activityNode = activities.find(a => rid === a.id || rid.startsWith(a.id + '-') || rid.endsWith('-' + a.id) || rid.includes('-' + a.id + '-'));
                                            if (activityNode) break;
                                        }
                                        if (activityNode) {
                                            jumpToActivityDetails(activityNode, 'agent', logs);
                                            matched = true;
                                            break;
                                        }

                                        for (const rid of candidates) {
                                            toolNode = allTools.find(t => rid === t.id || rid.startsWith(t.id + '-') || rid.endsWith('-' + t.id) || rid.includes('-' + t.id + '-'));
                                            if (toolNode) break;
                                        }
                                        if (toolNode) {
                                            jumpToActivityDetails(toolNode, 'tool', logs);
                                            matched = true;
                                            break;
                                        }
                                    }
                                    node = node.parentElement;
                                }

                                if (!matched) {
                                    console.warn('Workflow click: no matching node found (fallback)', {
                                        clickedTag: event.target.tagName,
                                        idChain: idChain,
                                        knownAgentIds: activities.map(a => a.id),
                                        knownToolIds: allTools.map(t => t.id)
                                    });
                                }
                            });
                        }
                    } catch (fallbackError) {
                        console.error('ÂõûÈÄÄÊ∏≤Êüì‰πüÂ§±Ë¥•:', fallbackError);
                        workflowContainer.innerHTML = 
                            '<div class="alert alert-warning">' +
                                '<i class="fas fa-exclamation-triangle"></i> Workflow rendering failed' +
                                '<br><small class="text-muted">MermaidÈîôËØØ: ' + error.message + '</small>' +
                            '</div>';
                    }
                }
            } else {
                workflowContainer.innerHTML = 
                    '<div class="alert alert-info">' +
                        '<i class="fas fa-info-circle"></i> MermaidÂ∫ìÊú™Âä†ËΩΩ' +
                        '<br><small class="text-muted">ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÁ®çÂêéÂÜçËØï</small>' +
                    '</div>';
            }
            
        } catch (error) {
            console.error('Workflow generation failed:', error);
            workflowContainer.innerHTML = 
                '<div class="alert alert-warning">' +
                    '<i class="fas fa-exclamation-triangle"></i> Workflow generation failed' +
                    '<br><small class="text-muted">ÈîôËØØ: ' + error.message + '</small>' +
                '</div>';
        } finally {
            // ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
            loadingIndicator.style.display = 'none';
        }
        
        // Ê≥®ÊÑèÔºöÁÇπÂáª‰∫ã‰ª∂Áé∞Âú®Áõ¥Êé•Âú®SVGÂÖÉÁ¥†‰∏äÁªëÂÆöÔºå‰∏çÈúÄË¶ÅÂÖ®Â±ÄÂáΩÊï∞
    }
    
    // Ë∑≥ËΩ¨Âà∞ÂØπÂ∫îÁöÑÊ¥ªÂä®ËØ¶ÊÉÖ
    function jumpToActivityDetails(activity, type, logs) {
        console.log('Ë∑≥ËΩ¨Âà∞Ê¥ªÂä®ËØ¶ÊÉÖ:', type, activity);
        
        const historyItems = document.querySelectorAll('.history-item');
        let targetItem = null;
        
        // ÂÆâÂÖ®Ê£ÄÊü•logsÊï∞ÁªÑ
        if (!logs || !Array.isArray(logs)) {
            console.error('Êó†ÊïàÁöÑlogsÊï∞ÁªÑ:', logs);
            return;
        }
        
        // ÊûÑÂª∫Êü•ÊâæÂÄôÈÄâÈ°πÂàóË°®ÔºåÊåâ‰ºòÂÖàÁ∫ßÊéíÂ∫è
        const candidates = [];
        
        if (type === 'agent') {
            // ÂØπ‰∫éAgentÔºå‰ºòÂÖàÁ∫ßÔºöËæìÂá∫ËÆ∞ÂΩï > ËæìÂÖ•ËÆ∞ÂΩï > Êó∂Èó¥Êà≥ÂåπÈÖç
            
            // 1. ÈÄöËøáoutputLogIndexÊü•ÊâæËæìÂá∫ËÆ∞ÂΩïÔºàÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºâ
            if (activity.outputLogIndex !== undefined && 
                activity.outputLogIndex >= 0 && 
                activity.outputLogIndex < logs.length) {
                const targetLog = logs[activity.outputLogIndex];
                candidates.push({
                    targetType: 'agent_output',
                    targetTimestamp: targetLog.timestamp,
                    targetRoleName: targetLog.role_name,
                    targetLogIndex: activity.outputLogIndex,
                    priority: 1
                });
            }
            
            // 2. ÈÄöËøálogIndexÊü•ÊâæËæìÂÖ•ËÆ∞ÂΩïÔºà‰∏≠Á≠â‰ºòÂÖàÁ∫ßÔºâ
            if (activity.logIndex !== undefined && 
                activity.logIndex >= 0 && 
                activity.logIndex < logs.length) {
                const targetLog = logs[activity.logIndex];
                candidates.push({
                    targetType: 'agent_input',
                    targetTimestamp: targetLog.timestamp,
                    targetRoleName: targetLog.role_name,
                    targetLogIndex: activity.logIndex,
                    priority: 2
                });
            }
            
            // 3. ÈÄöËøáÊó∂Èó¥Êà≥ÂåπÈÖçÔºàÊúÄ‰Ωé‰ºòÂÖàÁ∫ßÔºâ
            if (activity.outputTimestamp) {
                candidates.push({
                    targetType: 'agent_output',
                    targetTimestamp: activity.outputTimestamp,
                    targetRoleName: activity.originalName || activity.name,
                    targetLogIndex: activity.outputLogIndex,
                    priority: 3
                });
            }
            
            if (activity.timestamp) {
                candidates.push({
                    targetType: 'agent_input',
                    targetTimestamp: activity.timestamp,
                    targetRoleName: activity.originalName || activity.name,
                    targetLogIndex: activity.logIndex,
                    priority: 4
                });
            }
            
        } else if (type === 'tool') {
            // ÂØπ‰∫éToolÔºå‰ºòÂÖàÁ∫ßÔºölogIndexÊü•Êâæ > Êó∂Èó¥Êà≥ÂåπÈÖç
            
            // 1. ÈÄöËøálogIndexÊü•ÊâæËæìÂÖ•ËÆ∞ÂΩïÔºàÈ´ò‰ºòÂÖàÁ∫ßÔºâ
            if (activity.logIndex !== undefined && 
                activity.logIndex >= 0 && 
                activity.logIndex < logs.length) {
                const targetLog = logs[activity.logIndex];
                candidates.push({
                    targetType: 'tool_input',
                    targetTimestamp: targetLog.timestamp,
                    targetRoleName: targetLog.role_name,
                    targetLogIndex: activity.logIndex,
                    priority: 1
                });
            }
            
            // 2. ÈÄöËøáÊó∂Èó¥Êà≥ÂåπÈÖçÔºà‰Ωé‰ºòÂÖàÁ∫ßÔºâ
            if (activity.timestamp) {
                candidates.push({
                    targetType: 'tool_input',
                    targetTimestamp: activity.timestamp,
                    targetRoleName: activity.name,
                    targetLogIndex: activity.logIndex,
                    priority: 2
                });
            }
        }
        
        // Êåâ‰ºòÂÖàÁ∫ßÊéíÂ∫èÂÄôÈÄâÈ°π
        candidates.sort((a, b) => a.priority - b.priority);
        
        // ÈÅçÂéÜÂÄôÈÄâÈ°πÔºåÊåâ‰ºòÂÖàÁ∫ßÊü•ÊâæÂåπÈÖçÈ°π
        for (const candidate of candidates) {
            let foundForCandidate = false;

            // 1) ÂÖàÂ∞ùËØïÈÄöËøá‰∏•Ê†ºÁöÑ logIndex ÂåπÈÖçÔºàÂîØ‰∏Ä‰∏îÁ®≥ÂÆöÔºâ
            if (candidate.targetLogIndex !== undefined && candidate.targetLogIndex !== null) {
                const strictMatch = Array.from(historyItems).find(item => 
                    item.dataset.type === candidate.targetType &&
                    item.dataset.logIndex !== undefined &&
                    Number(item.dataset.logIndex) === Number(candidate.targetLogIndex)
                );
                if (strictMatch) {
                    targetItem = strictMatch;
                    foundForCandidate = true;
                }
            }

            // 2) Ëã•Êú™ÂëΩ‰∏≠ÔºåÊåâÊó∂Èó¥Êà≥‰ºòÂÖàÁ∫ßÂåπÈÖçÔºõÂêåÁ≠âÊù°‰ª∂‰∏ãÈÄâ‰∏éÁõÆÊ†áÁ¥¢ÂºïÊúÄËøëÁöÑÈ°π
            if (!foundForCandidate) {
                let bestItem = null;
                let bestScore = Infinity;

                for (const item of historyItems) {
                    const timestamp = item.dataset.timestamp;
                    const itemType = item.dataset.type;
                    const roleName = item.dataset.roleName;

                    if (itemType !== candidate.targetType) continue;

                    const normalizeTs = (v) => (v == null ? '' : String(v).trim());
                    const tsItem = normalizeTs(timestamp);
                    const tsCand = normalizeTs(candidate.targetTimestamp);
                    const secPart = (s) => s.replace('T',' ').slice(0, 19);
                    const tsEqual = tsItem && tsCand && tsItem === tsCand;
                    const tsEqualSec = tsItem && tsCand && secPart(tsItem) === secPart(tsCand);
                    let tsNear = false;
                    try {
                        const ti = Date.parse(tsItem);
                        const tc = Date.parse(tsCand);
                        if (!isNaN(ti) && !isNaN(tc)) {
                            tsNear = Math.abs(ti - tc) <= 2000; // 2 ÁßíÂÆπÂ∑Æ
                        }
                    } catch (_) {}

                    const roleMatch = candidate.targetRoleName && roleName && roleName === candidate.targetRoleName;

                    let quality = null;
                    if (tsEqual) quality = 0;
                    else if (tsEqualSec) quality = 1;
                    else if (tsNear) quality = 2;
                    else if (roleMatch) quality = 3;

                    if (quality !== null) {
                        let distance = 999999;
                        if (candidate.targetLogIndex !== undefined && candidate.targetLogIndex !== null && item.dataset.logIndex !== undefined) {
                            distance = Math.abs(Number(item.dataset.logIndex) - Number(candidate.targetLogIndex));
                        }
                        const score = quality * 100000 + distance;
                        if (score < bestScore) {
                            bestScore = score;
                            bestItem = item;
                        }
                    }
                }

                if (bestItem) {
                    targetItem = bestItem;
                    foundForCandidate = true;
                }
            }

            if (foundForCandidate) break; // ÊâæÂà∞ÁõÆÊ†áÈ°πÂ∞±Ë∑≥Âá∫
        }
        
        if (!targetItem) {
            console.warn('No matching history record item found (after all strategies):', {
                type,
                activity,
                candidatesCount: candidates.length,
                candidates,
                availableItems: Array.from(historyItems).map(el => ({ type: el.dataset.type, ts: el.dataset.timestamp, role: el.dataset.roleName }))
            });
        }
        
        if (targetItem) {
            // Ê∏ÖÈô§ÂΩìÂâçÊ¥ªÂä®È°π
            document.querySelectorAll('.history-item').forEach(item => item.classList.remove('active'));
            
            // ÊøÄÊ¥ªÁõÆÊ†áÈ°π
            targetItem.classList.add('active');
            
            // ÊªöÂä®Âà∞ÁõÆÊ†áÈ°π
            targetItem.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            // Ëß¶ÂèëÁÇπÂáª‰∫ã‰ª∂‰ª•ÊòæÁ§∫ËØ¶ÊÉÖ
            setTimeout(() => {
                targetItem.click();
            }, 300);
        } else {
            console.warn('No matching history record item found:', {
                type: type,
                activity: activity,
                candidatesCount: candidates.length,
                candidates: candidates
            });
        }
    }
    
    // Ëé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆ
    async function fetchLatestData(forceUpdate = false, skipHistoryUpdate = false) {
        try {
            const paths = window.location.pathname.split('/')
            const taskId = paths[paths.length - 1];
            const response = await fetch('/api/task/' + taskId + '/logs?timestamp=' + Date.now());
            
            if (response.ok) {
                const data = await response.json();
                console.log('Get task data, status: ' + data.task.status + ', log number: ' + data.logs.length + ', force update: ' + forceUpdate);
                
                // Ë∞ÉËØïÊó•ÂøóÊï∞ÊçÆÔºàÂ∑≤ÁßªÈô§‰ª•ÂáèÂ∞ëÊéßÂà∂Âè∞Âô™Èü≥Ôºâ
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÊï∞ÊçÆÂèòÂåñ
                const hasStatusChange = !currentTaskData || data.task.status !== currentTaskData.task.status;
                const hasLogChange = !currentTaskData || data.logs.length !== currentTaskData.logs.length;
                
                // ‰ºòÂåñÂÜÖÂÆπÂèòÂåñÊ£ÄÊµã - Êõ¥‰∏•Ê†ºÁöÑÂèòÂåñÊ£ÄÊµã
                let hasContentChange = false;
                if (!currentTaskData) {
                    hasContentChange = true;
                } else if (data.logs.length > 0 && currentTaskData.logs.length > 0 && data.logs.length === currentTaskData.logs.length) {
                    // Âè™ÊúâÂú®Êó•ÂøóÊï∞ÈáèÁõ∏ÂêåÊó∂ÊâçÊ£ÄÊü•ÂÜÖÂÆπÂèòÂåñÔºåÈÅøÂÖçÈáçÂ§çÊ£ÄÊµã
                    const newLastLog = data.logs[data.logs.length - 1];
                    const oldLastLog = currentTaskData.logs[currentTaskData.logs.length - 1];
                    hasContentChange = newLastLog.timestamp !== oldLastLog.timestamp || 
                                     newLastLog.content !== oldLastLog.content;
                } else if (data.logs.length !== currentTaskData.logs.length) {
                    hasContentChange = true; // Êï∞ÈáèÂèòÂåñ‰πüÁÆóÂÜÖÂÆπÂèòÂåñ
                }
                
                // Â¶ÇÊûúÊòØÂàùÊ¨°Âä†ËΩΩÊàñÂº∫Âà∂Êõ¥Êñ∞ÔºåÊàñËÄÖÊï∞ÊçÆÁ°ÆÂÆûÂèëÁîü‰∫ÜÂèòÂåñ
                if (forceUpdate || !currentTaskData || hasStatusChange || hasLogChange || hasContentChange) {
                    
                    console.log('Data changed, update interface:', {
                        forceUpdate,
                        hasStatusChange,
                        hasLogChange,
                        hasContentChange,
                        newLogCount: data.logs.length,
                        oldLogCount: currentTaskData ? currentTaskData.logs.length : 0
                    });
                    
                    // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
                    if (hasStatusChange) {
                        updateTaskStatus(data.task.status);
                    }
                    
                    // Êõ¥Êñ∞ÂéÜÂè≤ËÆ∞ÂΩïÂíåÊµÅÁ®ãÂõæ - Âè™ÊúâÂú®ÊúâÊó•ÂøóÂèòÂåñÊàñÂº∫Âà∂Êõ¥Êñ∞Êó∂ÊâçÊõ¥Êñ∞
                    if ((forceUpdate || hasLogChange || hasContentChange) && !skipHistoryUpdate) {
                        console.log('Trigger history record update...');
                        updateHistoryList(data.logs);
                        await generateWorkflowChart(data.logs);
                    } else if (skipHistoryUpdate) {
                        console.log('Skip history record update (skipHistoryUpdate=true)');
                        // Âç≥‰ΩøË∑≥ËøáÂéÜÂè≤ËÆ∞ÂΩïÊõ¥Êñ∞Ôºå‰πüË¶ÅÊõ¥Êñ∞ÊµÅÁ®ãÂõæ
                        await generateWorkflowChart(data.logs);
                    } else {
                        console.log('Skip history record update (no related changes)');
                    }
                    
                    currentTaskData = data;
                    
                    // Êõ¥Êñ∞ÊúÄÁªàÊâßË°åÁªìÊûú
                    if (data.task.result && data.task.status === 'completed') {
                        const resultContainer = document.getElementById('final-result-content');
                        if (resultContainer && (!resultContainer.innerHTML || resultContainer.innerHTML.includes('<!-- ÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÊ∏≤Êüì -->'))) {
                            console.log('üìù Update final execution result...');
                            const renderedResult = renderContent(data.task.result, 'agent_output');
                            resultContainer.innerHTML = renderedResult;
                            console.log('‚úÖ Final execution result updated');
                        }
                    }
                } else {
                    console.log('No data change, skip update');
                }
                
                return data;
            } else {
                console.error('Get data failed, HTTP status:', response.status);
            }
        } catch (error) {
            console.error('Get latest data failed:', error);
        }
        return null;
    }
    
    // Ëá™Âä®Âà∑Êñ∞ÈÄªËæë
    function startAutoRefresh() {
        // Á°Æ‰øùÊ≤°ÊúâÈáçÂ§çÁöÑÂÆöÊó∂Âô®
        if (refreshInterval) {
            console.log('Clear existing timer');
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
        
        console.log('üîÑ Start auto refresh timer - check update every 5 seconds');
        let refreshCount = 0;
        
        refreshInterval = setInterval(async () => {
            try {
                refreshCount++;
                console.log(`üì° Auto refresh #${refreshCount}:`, new Date().toLocaleTimeString());
                
                showRefreshIndicator();
                const data = await fetchLatestData();
                
                if (!data) {
                    console.warn('‚ö†Ô∏è Get data failed, will retry next time');
                    return;
                }
                
                // Â¶ÇÊûú‰ªªÂä°Â∑≤ÂÆåÊàêÊàñÂ§±Ë¥•ÔºåÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞
                if (data.task.status === 'completed' || data.task.status === 'failed') {
                    console.log('‚úÖ Task status changed to ' + data.task.status + ', stop auto refresh');
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                    
                    // Êõ¥Êñ∞Âà∑Êñ∞ÊåáÁ§∫Âô®ÊòæÁ§∫ÊúÄÁªàÁä∂ÊÄÅ
                    const indicator = document.getElementById('refresh-indicator');
                    if (indicator) {
                        indicator.textContent = '‚úÖ Task completed';
                        indicator.classList.add('active');
                        setTimeout(() => indicator.classList.remove('active'), 3000);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error during auto refresh:', error);
            }
        }, 5000); // 5 seconds refresh once, reduce frequency to avoid repeated problems
        
        console.log('‚úÖ Auto refresh timer started');
    }
    
    // ÂéÜÂè≤ËÆ∞ÂΩïÁÇπÂáª‰∫ã‰ª∂
    document.addEventListener('click', function(e) {
        const historyItem = e.target.closest('.history-item');
        if (historyItem) {
            document.querySelectorAll('.history-item').forEach(item => item.classList.remove('active'));
            historyItem.classList.add('active');
            
            const type = historyItem.dataset.type;
            const content = historyItem.dataset.content;
            const timestamp = historyItem.dataset.timestamp;
            const specificName = historyItem.dataset.roleName;
            
            let title = '';
            if (type === 'agent_input') {
                title = (specificName ? specificName : 'Agent') + ' input - ' + timestamp;
            } else if (type === 'agent_output') {
                title = (specificName ? specificName : 'Agent') + ' output - ' + timestamp;
            } else if (type === 'tool_input') {
                title = (specificName ? specificName : 'Tool') + ' call - ' + timestamp;
            } else if (type === 'tool_output') {
                title = (specificName ? specificName : 'Tool') + ' result - ' + timestamp;
            } else {
                title = type + ' - ' + timestamp;
            }
            
            let detailHtml = renderContent(content, type);
            
            document.getElementById('detail-title').textContent = title;
            document.getElementById('detail-content').innerHTML = detailHtml;
            
            // ÂΩì tool_output ÁöÑÂÜÖÂÆπ‰∏∫ JSON ‰∏îÂåÖÂê´ calculate_path Êó∂ÔºåÊ≥®ÂÖ•Âø´Êç∑ÈìæÊé•
            if (type === 'tool_output') {
                try {
                    const data = JSON.parse(content);
                    const basePathRaw = data && (data.calculate_path || data.calc_path || data.calculation_path);
                    if (basePathRaw && typeof basePathRaw === 'string' && basePathRaw.trim() !== '') {
                        const basePath = basePathRaw.endsWith('/') ? basePathRaw.slice(0, -1) : basePathRaw;
                        const incarPath = basePath + '/INCAR';
                        const kpointsPath = basePath + '/KPOINTS';
                        const contcarPath = basePath + '/CONTCAR';
                        const oszicarPath = basePath + '/OSZICAR';
                        const outcarPath = basePath + '/OUTCAR';
                        const doscarPath = basePath + '/DOSCAR';
                        const eigenvalPath = basePath + '/EIGENVAL';
                        
                        const linksContainer = document.createElement('div');
                        linksContainer.className = 'mt-3';
                        linksContainer.innerHTML =
                            '<div class="small text-muted mb-2">ËÆ°ÁÆóÁõÆÂΩï: <code class="file-path">' + basePath + '</code></div>' +
                            '<div>' +
                                '<a href="#" class="btn btn-sm btn-outline-secondary me-2" onclick="showTextFile(decodeURIComponent(\'' + encodeURIComponent(incarPath) + '\'))">' +
                                    '<i class="fas fa-file-alt"></i> show INCAR</a>' +
                                '<a href="#" class="btn btn-sm btn-outline-secondary me-2" onclick="showTextFile(decodeURIComponent(\'' + encodeURIComponent(kpointsPath) + '\'))">' +
                                    '<i class="fas fa-file-alt"></i> show KPOINTS</a>' +
                                '<a href="#" class="btn btn-sm btn-outline-secondary me-2" onclick="showTextFile(decodeURIComponent(\'' + encodeURIComponent(contcarPath) + '\'))">' +
                                    '<i class="fas fa-file-alt"></i> show CONTCAR</a>' +
                                '<a href="#" class="btn btn-sm btn-outline-secondary me-2" onclick="showTextFile(decodeURIComponent(\'' + encodeURIComponent(oszicarPath) + '\'))">' +
                                    '<i class="fas fa-file-alt"></i> show OSZICAR</a>' +
                                '<a href="#" class="btn btn-sm btn-outline-info" onclick="downloadByFilePath(decodeURIComponent(\'' + encodeURIComponent(outcarPath) + '\'))">' +
                                    '<i class="fas fa-download"></i> download OUTCAR</a>' +
                                '<a href="#" class="btn btn-sm btn-outline-info" onclick="downloadByFilePath(decodeURIComponent(\'' + encodeURIComponent(doscarPath) + '\'))">' +
                                    '<i class="fas fa-download"></i> download DOSCAR</a>' +
                                '<a href="#" class="btn btn-sm btn-outline-info" onclick="downloadByFilePath(decodeURIComponent(\'' + encodeURIComponent(eigenvalPath) + '\'))">' +
                                    '<i class="fas fa-download"></i> download EIGENVAL</a>' +
                            '</div>';
                        const detailEl = document.getElementById('detail-content');
                        detailEl.appendChild(linksContainer);
                    }
                } catch (e) { /* Èùû JSON ÂøΩÁï• */ }
            }
            
            if (window.Prism) {
                Prism.highlightAll();
            }
        }
    });
    
    // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÊó∂ÁöÑÂ§ÑÁêÜ
    document.addEventListener('visibilitychange', async function() {
        if (document.hidden) {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        } else {
            // È°µÈù¢ÈáçÊñ∞ÂèØËßÅÊó∂ÔºåÊ£ÄÊü•‰ªªÂä°Áä∂ÊÄÅÂÜçÂÜ≥ÂÆöÊòØÂê¶ÈáçÊñ∞ÂºÄÂßãÂà∑Êñ∞
            if (!refreshInterval) {
                const data = await fetchLatestData(false); // ‰∏çÂº∫Âà∂Êõ¥Êñ∞ÔºåÈÅøÂÖç‰∏çÂøÖË¶ÅÁöÑÁä∂ÊÄÅÈó™ÁÉÅ
                if (data && data.task.status !== 'completed' && data.task.status !== 'failed') {
                    console.log('Page reappeared, task status: ' + data.task.status + ', restart auto refresh');
                    startAutoRefresh();
                } else {
                    console.log('Page reappeared, task status: ' + (data?.task.status || 'Unknown') + ', no auto refresh');
                }
            }
        }
    });
    
    // ÂÖ®Â±ÄÂèòÈáè
    let jsmolApplets = {};
    let currentTaskId = null;
    
    // Ëé∑ÂèñÂΩìÂâç‰ªªÂä°ID
    function getCurrentTaskId() {
        if (!currentTaskId) {
            currentTaskId = window.location.pathname.split('/')[2];
        }
        return currentTaskId;
    }
    
    // ÂàùÂßãÂåñJSMol
    function initializeJSMol() {
        if (typeof Jmol !== 'undefined') {
            Jmol.setDocument(document);
            console.log('JSMol initialized');
        }
    }
    
    // ÊûÑÂª∫Êñá‰ª∂ API URLÔºàÊîØÊåÅÁªùÂØπË∑ØÂæÑÔºâ
    function buildFileApiUrl(filePath) {
        const taskId = getCurrentTaskId();
        let processedPath = filePath || '';
        if (processedPath.startsWith('/')) {
            processedPath = '__ABS__' + processedPath;
        }
        const pathSegments = processedPath.split('/');
        const encodedSegments = pathSegments.map(segment => encodeURIComponent(segment));
        const encodedPath = encodedSegments.join('/');
        return '/api/files/' + taskId + '/' + encodedPath;
    }

    function getFileName(filePath) {
        if (!filePath) return 'file.txt';
        const parts = filePath.split('/');
        return parts[parts.length - 1] || 'file.txt';
    }

    // ‰ª•ÊñáÊú¨ÊñπÂºèÂ±ïÁ§∫Êñá‰ª∂ÂÜÖÂÆπ
    function showTextFile(filePath) {
        const displayArea = document.getElementById('file-display-area');
        const displayTitle = document.getElementById('file-display-title');
        const displayContent = document.getElementById('file-display-content');

        const apiUrl = buildFileApiUrl(filePath);

        displayTitle.innerHTML = '<i class="fas fa-file-alt"></i> Êñá‰ª∂ÂÜÖÂÆπ: ' + filePath;
        displayContent.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <div class="mt-2">Âä†ËΩΩÊñá‰ª∂ÂÜÖÂÆπ...</div>
            </div>
        `;
        displayArea.style.display = 'block';
        displayArea.scrollIntoView({ behavior: 'smooth' });

        fetch(apiUrl)
            .then(resp => {
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                return resp.text();
            })
            .then(text => {
                displayContent.innerHTML = '';
                const toolbar = document.createElement('div');
                toolbar.className = 'mb-2';
                toolbar.innerHTML = '<button class="btn btn-sm btn-outline-info" onclick="downloadByFilePath(\'' + filePath.replace(/'/g, "\\'") + '\')">' +
                                    '<i class="fas fa-download"></i> ‰∏ãËΩΩ</button>';
                const pre = document.createElement('pre');
                pre.className = 'mb-0';
                const code = document.createElement('code');
                code.textContent = text;
                pre.appendChild(code);
                displayContent.appendChild(toolbar);
                displayContent.appendChild(pre);
                if (window.Prism) {
                    Prism.highlightAll();
                }
            })
            .catch(err => {
                displayContent.innerHTML = 
                    '<div class="alert alert-danger">' +
                        '‚ùå Êñá‰ª∂Âä†ËΩΩÂ§±Ë¥•: ' + err.message + '<br>' +
                        '<small class="text-muted">' + apiUrl + '</small>' +
                    '</div>';
            });
    }

    // ÈÄöËøáÊñá‰ª∂Ë∑ØÂæÑ‰∏ãËΩΩ
    function downloadByFilePath(filePath) {
        const url = buildFileApiUrl(filePath);
        downloadFile(url, getFileName(filePath));
    }
    
    // ÊòæÁ§∫ÂõæÁâáÊñá‰ª∂
    function showImageFile(filePath, buttonId) {
        const taskId = getCurrentTaskId();
        const displayArea = document.getElementById('file-display-area');
        const displayTitle = document.getElementById('file-display-title');
        const displayContent = document.getElementById('file-display-content');
        
        // ÂØπÊñá‰ª∂Ë∑ØÂæÑËøõË°åÂÆâÂÖ®ÁºñÁ†ÅÔºåÁâπÂà´Â§ÑÁêÜÁªùÂØπË∑ØÂæÑ
        let processedPath = filePath;
        
        // Â¶ÇÊûúÊòØÁªùÂØπË∑ØÂæÑÔºåÊ∑ªÂä†ÁâπÊÆäÊ†áËÆ∞Êù•‰øùÊä§ÂºÄÂ§¥ÁöÑ /
        if (filePath.startsWith('/')) {
            processedPath = '__ABS__' + filePath;
        }
        
        // Â∞ÜË∑ØÂæÑÂàÜÊÆµÔºåÈÄêÊÆµÁºñÁ†ÅÔºåÁÑ∂ÂêéÈáçÊñ∞ÁªÑÂêà
        const pathSegments = processedPath.split('/');
        const encodedSegments = pathSegments.map(segment => encodeURIComponent(segment));
        const encodedPath = encodedSegments.join('/');
        const apiUrl = '/api/files/' + taskId + '/' + encodedPath;
        
        console.log('Original path:', filePath);
        console.log('Processed path:', processedPath);
        console.log('Encoded path:', encodedPath);
        console.log('Full API URL:', apiUrl);
        
        // Êõ¥Êñ∞Ê†áÈ¢ò
        displayTitle.innerHTML = '<i class="fas fa-image"></i> Image preview: ' + filePath;
        
        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        displayContent.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <div class="mt-2">Loading image...</div>
            </div>
        `;
        
        // ÊòæÁ§∫ÊòæÁ§∫Âå∫Âüü
        displayArea.style.display = 'block';
        displayArea.scrollIntoView({ behavior: 'smooth' });
        
        // Âä†ËΩΩÂõæÁâá
        const img = new Image();
        img.onload = function() {
            displayContent.innerHTML = 
                '<div class="text-center">' +
                    '<img src="' + apiUrl + '" class="content-image" alt="' + filePath + '">' +
                    '<div class="mt-2">' +
                        '<small class="text-muted">File path: ' + filePath + '</small>' +
                    '</div>' +
                '</div>';
            console.log('Image loaded successfully:', filePath);
        };
        
        img.onerror = function() {
            displayContent.innerHTML = 
                '<div class="alert alert-warning">' +
                    '<i class="fas fa-exclamation-triangle"></i> Failed to load image' +
                    '<br><strong>File path:</strong> ' + filePath +
                    '<br><strong>API URL:</strong> ' + apiUrl +
                    '<br><small class="text-muted">Please check if the file exists or the path is correct</small>' +
                '</div>';
            console.error('Image loading failed:', filePath);
        };
        
        img.src = apiUrl;
    }
    
    // ÊòæÁ§∫VASPÊô∂‰ΩìÁªìÊûÑÊñá‰ª∂
    function showVaspFile(filePath, buttonId) {
        const taskId = getCurrentTaskId();
        const displayArea = document.getElementById('file-display-area');
        const displayTitle = document.getElementById('file-display-title');
        const displayContent = document.getElementById('file-display-content');
        
        // ÂØπÊñá‰ª∂Ë∑ØÂæÑËøõË°åÂÆâÂÖ®ÁºñÁ†ÅÔºåÁâπÂà´Â§ÑÁêÜÁªùÂØπË∑ØÂæÑ
        let processedPath = filePath;
        
        // Â¶ÇÊûúÊòØÁªùÂØπË∑ØÂæÑÔºåÊ∑ªÂä†ÁâπÊÆäÊ†áËÆ∞Êù•‰øùÊä§ÂºÄÂ§¥ÁöÑ /
        if (filePath.startsWith('/')) {
            processedPath = '__ABS__' + filePath;
        }
        
        // Â∞ÜË∑ØÂæÑÂàÜÊÆµÔºåÈÄêÊÆµÁºñÁ†ÅÔºåÁÑ∂ÂêéÈáçÊñ∞ÁªÑÂêà
        const pathSegments = processedPath.split('/');
        const encodedSegments = pathSegments.map(segment => encodeURIComponent(segment));
        const encodedPath = encodedSegments.join('/');
        const apiUrl = '/api/files/' + taskId + '/' + encodedPath;
        
        console.log('Original path:', filePath);
        console.log('Processed path:', processedPath);
        console.log('Encoded path:', encodedPath);
        console.log('Full API URL:', apiUrl);
        
        // Êõ¥Êñ∞Ê†áÈ¢ò
        displayTitle.innerHTML = '<i class="fas fa-cube"></i> Êô∂‰ΩìÁªìÊûÑ: ' + filePath;
        
        // ÂàõÂª∫JSMolÂÆπÂô®
        const jsmolId = 'jsmol_display_' + Date.now();
        displayContent.innerHTML = 
            '<div class="jsmol-container">' +
                '<div class="text-center mb-3">' +
                    '<h6>Crystal structure visualization</h6>' +
                    '<small class="text-muted">File: ' + filePath + '</small>' +
                '</div>' +
                '<div id="' + jsmolId + '" style="width: 500px; height: 500px; margin: 0 auto; background-color: #fff; border: 1px solid #ccc; border-radius: 5px;"></div>' +
                '<div class="mt-3">' +
                    '<button class="btn btn-sm btn-primary" onclick="loadVaspStructure(\'' + jsmolId + '\', \'' + apiUrl + '\')">' +
                        '<i class="fas fa-play"></i> load structure' +
                    '</button>' +
                    '<button class="btn btn-sm btn-secondary ms-2" onclick="resetVaspView(\'' + jsmolId + '\')">' +
                        '<i class="fas fa-redo"></i> reset view' +
                    '</button>' +
                    '<button class="btn btn-sm btn-info ms-2" onclick="downloadFile(\'' + apiUrl + '\', \'' + filePath + '\')">' +
                        '<i class="fas fa-download"></i> download file' +
                    '</button>' +
                '</div>' +
            '</div>';
        
        // ÊòæÁ§∫ÊòæÁ§∫Âå∫Âüü
        displayArea.style.display = 'block';
        displayArea.scrollIntoView({ behavior: 'smooth' });
        
        console.log('Prepare to display VASP structure:', filePath);
    }
    
    // ÂÖ≥Èó≠Êñá‰ª∂ÊòæÁ§∫Âå∫Âüü
    function closeFileDisplay() {
        const displayArea = document.getElementById('file-display-area');
        displayArea.style.display = 'none';
        
        // Ê∏ÖÁêÜJSMolÂÆû‰æã
        const displayContent = document.getElementById('file-display-content');
        displayContent.innerHTML = '';
        
        console.log('Close file display area');
    }
    
    // ‰∏ãËΩΩÊñá‰ª∂
    function downloadFile(url, filename) {
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // Âä†ËΩΩVASPÊô∂‰ΩìÁªìÊûÑ
    function loadVaspStructure(containerId, fileUrl) {
        if (typeof Jmol === 'undefined') {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        ‚ö†Ô∏è JSMol not loaded, please try again later
                        <br><small class="text-muted">JSMol is loading from CDN...</small>
                    </div>
                `;
            }
            return;
        }
        
        const container = document.getElementById(containerId);
        if (!container) {
            console.error('JSMol container not found:', containerId);
            return;
        }
        
        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        container.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <div class="mt-2">Loading crystal structure...</div>
            </div>
        `;
        
        // Á°ÆÂÆöJSMolÂÆπÂô®ÁöÑÂ∞∫ÂØ∏
        const containerWidth = container.style.width ? parseInt(container.style.width) : 500;
        const containerHeight = container.style.height ? parseInt(container.style.height) : 500;
        
        // JSMolÂ∫îÁî®Á®ãÂ∫èÈÖçÁΩÆ
        const jsmolInfo = {
            width: containerWidth,
            height: containerHeight,
            debug: false,
            color: "white",
            addSelectionOptions: false,
            use: "HTML5",
            j2sPath: "https://chemapps.stolaf.edu/jmol/jsmol/j2s",
            readyFunction: function(applet) {
                console.log('JSMol applet ' + applet._id + ' ready, load file: ' + fileUrl);
            },
            script: 
                'load "' + fileUrl + '";' +
                'if (_loadScript.error) {' +
                    'print "File loading failed: ' + fileUrl + '";' +
                    'background white;' +
                    'color red;' +
                    'set echo top center;' +
                    'echo "File loading failed";' +
                '} else {' +
                    'spacefill 20%;' +
                    'wireframe 0.15;' +
                    'axes on;' +
                    'unitcell on;' +
                    'rotate best;' +
                    'zoom 100;' +
                    'background white;' +
                '}'
        };
        
        try {
            setTimeout(() => {
                // ÂàõÂª∫JSMolÂ∫îÁî®Á®ãÂ∫è
                const appletName = 'jsmolApplet_' + containerId;
                const appletHtml = Jmol.getAppletHtml(appletName, jsmolInfo);
                container.innerHTML = appletHtml;
                jsmolApplets[containerId] = appletName;
                
                console.log('Loading crystal structure: ' + fileUrl);
            }, 100);
        } catch (error) {
            console.error('Loading crystal structure failed:', error);
            container.innerHTML = 
                '<div class="alert alert-danger">' +
                    '‚ùå Loading crystal structure failed: ' + error.message +
                    '<br><small class="text-muted">Please check if the file exists: ' + fileUrl + '</small>' +
                    '<div class="mt-2">' +
                        '<button class="btn btn-sm btn-outline-primary" onclick="downloadFile(\'' + fileUrl + '\', \'structure.vasp\')">' +
                            '<i class="fas fa-download"></i> download file to view' +
                        '</button>' +
                    '</div>' +
                            '</div>';
        }
    }
    
    // ÈáçÁΩÆJSMolËßÜÂõæ
    function resetVaspView(containerId) {
        const appletName = jsmolApplets[containerId];
        if (appletName && typeof Jmol !== 'undefined') {
            try {
                Jmol.script(appletName, "rotate best; zoom 100; center;");
                console.log('Reset crystal structure view');
            } catch (error) {
                console.error('Reset view failed:', error);
            }
        }
    }
    
    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂºÄÂßãËá™Âä®Âà∑Êñ∞
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('üöÄ Start initializing Task detail page...');
        
        // ÂàùÂßãÂåñMarkedÈÖçÁΩÆ
        if (typeof marked !== 'undefined') {
            marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false
            });
            console.log('‚úÖ Marked initialized');
        } else {
            console.warn('‚ö†Ô∏è Marked library not loaded');
        }
        
        // ÂàùÂßãÂåñMermaid
        if (typeof mermaid !== 'undefined') {
            mermaid.initialize({ 
                startOnLoad: false, // ÊâãÂä®ÊéßÂà∂ÂàùÂßãÂåñ
                theme: 'default',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true,
                    curve: 'basis'
                },
                securityLevel: 'loose', // ÂÖÅËÆ∏ÁÇπÂáª‰∫ã‰ª∂
                themeVariables: {
                    primaryColor: '#e3f2fd',
                    primaryTextColor: '#000',
                    primaryBorderColor: '#1976d2',
                    lineColor: '#333',
                    sectionBkgColor: '#f8f9fa',
                    altSectionBkgColor: '#fff',
                    gridColor: '#e0e0e0'
                }
            });
            console.log('‚úÖ Mermaid initialized (version: ' + mermaid.version + ')');
        } else {
            console.warn('‚ö†Ô∏è Mermaid library not loaded');
        }
        
        // ÂàùÂßãÂåñJSMol
        initializeJSMol();
        
        // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÈùôÊÄÅÊ∏≤ÊüìÁöÑÂéÜÂè≤ËÆ∞ÂΩï
        const existingHistoryItems = document.querySelectorAll('.history-item');
        const hasStaticContent = existingHistoryItems.length > 0;
        
        console.log(`üì° Start getting initial data... (detected ${hasStaticContent ? 'has' : 'no'} static content, currently ${existingHistoryItems.length} history items)`);
        
        // ÂàùÂßãÂåñËé∑Âèñ‰∏ÄÊ¨°Êï∞ÊçÆÔºåÂ¶ÇÊûúÊúâÈùôÊÄÅÂÜÖÂÆπÂ∞±Ë∑≥ËøáÂéÜÂè≤ËÆ∞ÂΩïÊõ¥Êñ∞‰ª•ÈÅøÂÖçÈáçÂ§ç
        const initialData = await fetchLatestData(true, hasStaticContent);
        
        if (!initialData) {
            console.error('‚ùå Failed to get initial data');
            return;
        }
        
        console.log('‚úÖ Initial data obtained successfully:', {
            status: initialData.task.status,
            logCount: initialData.logs.length,
            hasStaticContent: hasStaticContent
        });
        
        // Âè™ÊúâÂú®Ê≤°ÊúâÈùôÊÄÅÂÜÖÂÆπÊó∂ÊâçÈúÄË¶ÅÊâãÂä®Êõ¥Êñ∞ÂéÜÂè≤ËÆ∞ÂΩï
        // Â¶ÇÊûúÊúâÈùôÊÄÅÂÜÖÂÆπÔºåfetchLatestDataÂ∑≤ÁªèË∑≥Ëøá‰∫ÜÂéÜÂè≤Êõ¥Êñ∞ÔºåËøôÈáå‰πü‰∏çÈúÄË¶ÅÂÜçÊõ¥Êñ∞
        if (!hasStaticContent) {
            console.log('üîÑ Update history record list (no static content)...');
            updateHistoryList(initialData.logs);
        } else {
            console.log('‚è≠Ô∏è Skip history record update (using static rendering content)');
            // ‰øùÂ≠òÂΩìÂâçÊï∞ÊçÆ‰æõÂêéÁª≠ÊØîËæÉ
            currentTaskData = initialData;
        }
        
        // ÁîüÊàêÂàùÂßãÊµÅÁ®ãÂõæ
        if (initialData && initialData.logs) {
            console.log('üé® Start generating initial workflow chart...');
            await generateWorkflowChart(initialData.logs);
        }
        
        // Ê∏≤ÊüìÊúÄÁªàÊâßË°åÁªìÊûú
        const resultContainer = document.getElementById('final-result-content');
        if (resultContainer) {
            // ‰ºòÂÖà‰ΩøÁî®APIÊï∞ÊçÆÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÊ£ÄÊü•ÊòØÂê¶ÊúâÈùôÊÄÅÊï∞ÊçÆ
            let resultData = null;
            if (initialData && initialData.task.result) {
                resultData = initialData.task.result;
                console.log('üìù Use API data to render final execution result...');
            } else {
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÈùôÊÄÅÁöÑtask.resultÊï∞ÊçÆÔºàÈÄöËøáJinja2Ê®°Êùø‰º†ÈÄíÁöÑÔºâ
                const staticResultElement = document.querySelector('[data-static-result]');
                if (staticResultElement) {
                    resultData = staticResultElement.getAttribute('data-static-result');
                    console.log('üìù Use static data to render final execution result...');
                }
            }
            
            if (resultData) {
                const renderedResult = renderContent(resultData, 'agent_output');
                resultContainer.innerHTML = renderedResult;
                console.log('‚úÖ Final execution result rendered');
            }
        }
        
        // Âè™ÊúâÂΩì‰ªªÂä°ËøòÂú®ËøêË°åÊàñÁ≠âÂæÖÊó∂ÊâçÂºÄÂßãËá™Âä®Âà∑Êñ∞
        if (initialData && initialData.task.status !== 'completed' && initialData.task.status !== 'failed') {
            console.log('üîÑ Task status: ' + initialData.task.status + ', start auto refresh');
            startAutoRefresh();
        } else {
            console.log('‚èπÔ∏è Task status: ' + (initialData?.task.status || 'Unknown') + ', no auto refresh');
            // Ê∏ÖÁêÜÂèØËÉΩÂ≠òÂú®ÁöÑÂÆöÊó∂Âô®
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        // ÂàùÂßãÂåñÂÅúÊ≠¢ÊåâÈíÆÁä∂ÊÄÅ
        if (initialData && initialData.task) {
            updateStopButton(initialData.task.status);
        }
        
        console.log('üéâ Task detail page initialized!');
    });
    
    // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    });
    
    // ÂÖ®Â±ÄÂáΩÊï∞Ôºå‰æõHTML onclickË∞ÉÁî®
    window.loadVaspStructure = loadVaspStructure;
    window.resetVaspView = resetVaspView;
    window.showImageFile = showImageFile;
    window.showVaspFile = showVaspFile;
    window.closeFileDisplay = closeFileDisplay;
    window.downloadFile = downloadFile;
    window.stopTask = stopTask;
    window.showTextFile = showTextFile;
    window.downloadByFilePath = downloadByFilePath;
    </script>
</body>
</html> 